// ==UserScript==
// @name        QT20
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     3.7.18
// @description Production build
// @match       https://lyntron.on.plex.com/SalesAndCRM*
// @match       https://lyntron.on.plex.com/SalesAndCrm*
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.18/TamperHost/wwwroot/lt-plex-tm-utils.user.js?v=3.7.18
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.18/TamperHost/wwwroot/lt-plex-auth.user.js?v=3.7.18
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.18/TamperHost/wwwroot/lt-ui-hub.js?v=3.7.18
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.18/TamperHost/wwwroot/lt-data-core.user.js?v=3.7.18
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.18/TamperHost/wwwroot/lt-core.user.js?v=3.7.18
// @resource     THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.18/TamperHost/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @run-at      document-start
// @noframes
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt20.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt20.user.js
// ==/UserScript==

(()=>{(()=>{"use strict";let S=(...t)=>!1,x=(...t)=>console.error("QT20 \u2716\uFE0F",...t),m=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko,A=()=>new Promise(t=>requestAnimationFrame(t));(!("__LT_HUB_MOUNT"in window)||!window.__LT_HUB_MOUNT)&&(window.__LT_HUB_MOUNT="nav"),(async()=>{try{await window.ensureLTHub?.({mount:window.__LT_HUB_MOUNT})}catch{}})();let k=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i];if(!k.some(t=>t.test(location.pathname)))return;let c={ACTIONS_UL_SEL:".plex-dialog-has-buttons .plex-actions-wrapper ul.plex-actions",MODAL_TITLE:"Quote Part Detail",NOTE_SEL:'textarea[name="NoteNew"]',DS_STOCK:172,ACTION_BAR_SEL:"#QuoteWizardSharedActionBar",GRID_SEL:".plex-grid",POLL_MS:200,TIMEOUT_MS:12e3,SETTINGS_KEY:"qt20_settings_v2",DEFAULTS:{includeBreakdown:!0,includeTimestamp:!0}};async function L(){let t=document.querySelector(c.GRID_SEL)?c.GRID_SEL:c.ACTION_BAR_SEL;if(window.TMUtils?.waitForModelAsync){let{viewModel:o}=await window.TMUtils.waitForModelAsync(t,{pollMs:c.POLL_MS,timeoutMs:c.TIMEOUT_MS,requireKo:!0})??{viewModel:null};if(o)return o}let e=document.querySelector(".plex-wizard, .plex-page");return e&&(m?.dataFor?.(e)||null)}function I(){try{let e=document.querySelector(c.GRID_SEL);if(e&&m?.dataFor){let o=m.dataFor(e),r=Array.isArray(o?.datasource?.raw)?o.datasource.raw[0]:null,l=r?window.TMUtils?.getObsValue?.(r,"QuoteKey"):null;if(l!=null)return Number(l)}}catch{}try{let e=document.querySelector(".plex-wizard, .plex-page"),o=e?m?.dataFor?.(e):null,r=o&&(window.TMUtils?.getObsValue?.(o,"QuoteKey")||window.TMUtils?.getObsValue?.(o,"Quote.QuoteKey"));if(r!=null)return Number(r)}catch{}let t=/[?&]QuoteKey=(\d+)/i.exec(location.search);return t?Number(t[1]):null}let B=t=>{let e=lt?.core?.auth?.withFreshAuth;return typeof e=="function"?e(t):t()};function b(){try{let t=GM_getValue(c.SETTINGS_KEY,null);if(!t)return{...c.DEFAULTS};let e=typeof t=="string"?JSON.parse(t):t;return{...c.DEFAULTS,...e}}catch{return{...c.DEFAULTS}}}function O(t){try{GM_setValue(c.SETTINGS_KEY,JSON.stringify(t))}catch{}}function N(t){let e=String(t||"").trim(),o=e.match(/^(.*?)-(\d+)\s*(BAG|BOX|PACK|PKG)$/i);return o?{base:o[1],packSize:Number(o[2]),packUnit:o[3].toUpperCase()}:{base:e,packSize:null,packUnit:null}}function F(t){return N(t).base}function P(t,e){let o=String(t?.Part_No||"").trim(),{base:r,packSize:l}=N(o);if(!r||r!==e)return 0;let n=String(t?.Unit||"").toLowerCase(),a=Number(t?.Quantity)||0;return n===""||n==="pcs"||n==="piece"||n==="pieces"?a:l?a*l:a}function K(t,e){let o=new Map,r=0;for(let n of t||[]){let a=P(n,e);if(!a)continue;let i=String(n?.Location||n?.Warehouse||n?.Site||"UNK").trim();r+=a,o.set(i,(o.get(i)||0)+a)}let l=[...o].map(([n,a])=>({loc:n,qty:a})).sort((n,a)=>a.qty-n.qty);return{sum:r,breakdown:l}}let M=t=>Number(t).toLocaleString("en-US",{maximumFractionDigits:0});function R(t){let e=o=>String(o).padStart(2,"0");return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}`}async function T(t){let e=lt.core.hub.beginTask("Fetching stock\u2026","info");try{await L();let o=I();if(!o||!Number.isFinite(o)||o<=0)throw new Error("Quote Key not found");let r=t.querySelector(c.NOTE_SEL)||document.querySelector(c.NOTE_SEL);if(!r)throw new Error("NoteNew textarea not found");let n=m?.contextFor?.(r)?.$root?.data;if(!n)throw new Error("Knockout context not found");let a=$(n);if(!a)throw new Error("PartNo not available");let i=F(a),u=typeof getPlexFacade=="function"?await getPlexFacade():window.lt?.core?.plex??window.TMUtils,g=await B(()=>u.dsRows(c.DS_STOCK,{Part_No:i,Shippable:"TRUE",Container_Status:"OK"})),{sum:h,breakdown:p}=K(g||[],i),w=b(),f=[`STK: ${M(h)} pcs`];if(w.includeBreakdown&&p.length){let et=p.map(({loc:nt,qty:ot})=>`${nt} ${M(ot)}`).join(", ");f.push(`(${et})`)}w.includeTimestamp&&f.push(`@${R(new Date)}`);let s=f.join(" "),d=window.TMUtils?.getObsValue?.(n,"NoteNew",{trim:!0})||"",C=(/^(null|undefined)$/i.test(d)?"":d).replace(/(?:^|\s)STK:\s*\d[\d,]*(?:\s*pcs)?(?:\s*\([^()]*\))?(?:\s*@\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})?/gi,"").trim(),D=C?`${C} ${s}`:s;!window.TMUtils?.setObsValue?.(n,"NoteNew",D)&&r&&(r.value=D,r.dispatchEvent(new Event("input",{bubbles:!0}))),e.success("Stock updated",1500),lt.core.hub.notify("Stock results copied to Note","success",{ms:2500,toast:!0}),S("QT20 success",{qk:o,partNo:a,basePart:i,sum:h,breakdown:p})}catch(o){e.error("Failed"),lt.core.hub.notify(`Stock check failed: ${o?.message||o}`,"error",{ms:4e3,toast:!0}),x("handleClick:",o)}finally{restore()}}function $(t){let e=["PartNo","ItemNo","Part_Number","Item_Number","Part","Item"];for(let o of e){let r=window.TMUtils?.getObsValue?.(t,o,{first:!0,trim:!0});if(r)return r}return""}function Q(t,e){if(!t||!t.ownerDocument)return()=>{};let o=new MutationObserver(r=>{for(let l of r)for(let n of l.removedNodes||[])if(n===t||n.contains&&n.contains(t)){try{e()}finally{o.disconnect()}return}});return o.observe(t.ownerDocument.body,{childList:!0,subtree:!0}),()=>o.disconnect()}function z(t){try{let h=function(){u.style.display="block",document.addEventListener("mousedown",w,!0),document.addEventListener("keydown",f,!0)},p=function(){u.style.display="none",document.removeEventListener("mousedown",w,!0),document.removeEventListener("keydown",f,!0)},w=function(s){!u.contains(s.target)&&s.target!==i&&p()},f=function(s){s.key==="Escape"&&p()},e=t.closest(".plex-dialog");if(!(e?.querySelector(".plex-dialog-title")?.textContent?.trim()===c.MODAL_TITLE||e?.querySelector(c.NOTE_SEL))||t.dataset.qt20Injected)return;t.dataset.qt20Injected="1",S("injecting controls");let l=document.createElement("li"),n=document.createElement("a");n.href="javascript:void(0)",n.textContent="LT Get Stock Levels",n.title="Append normalized stock summary to Note",n.setAttribute("aria-label","Get stock levels"),n.setAttribute("role","button"),Object.assign(n.style,{cursor:"pointer",transition:"filter .15s, text-decoration-color .15s"}),n.addEventListener("mouseenter",()=>{n.style.filter="brightness(1.08)",n.style.textDecoration="underline"}),n.addEventListener("mouseleave",()=>{n.style.filter="",n.style.textDecoration=""}),n.addEventListener("focus",()=>{n.style.outline="2px solid #4a90e2",n.style.outlineOffset="2px"}),n.addEventListener("blur",()=>{n.style.outline="",n.style.outlineOffset=""}),n.addEventListener("click",()=>T(e)),n.addEventListener("keydown",s=>{(s.key==="Enter"||s.key===" ")&&(s.preventDefault(),T(e))}),l.appendChild(n),t.appendChild(l);let a=document.createElement("li"),i=document.createElement("a");i.href="javascript:void(0)",i.textContent="\u2699\uFE0F",i.title="QT20 Settings (breakdown / timestamp)",i.setAttribute("aria-label","QT20 Settings"),Object.assign(i.style,{marginLeft:"8px",fontSize:"16px",lineHeight:"1",cursor:"pointer",transition:"transform .15s, filter .15s"});let u=document.createElement("div");u.className="qt20-settings",Object.assign(u.style,{position:"absolute",top:"40px",right:"16px",minWidth:"220px",padding:"10px 12px",border:"1px solid #ccc",borderRadius:"8px",background:"#fff",boxShadow:"0 6px 20px rgba(0,0,0,0.15)",zIndex:"9999",display:"none"});let g=b();u.innerHTML=`
        <div style="font-weight:600; margin-bottom:8px;">QT20 Settings</div>
        <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
          <input type="checkbox" id="qt20-breakdown" ${g.includeBreakdown?"checked":""}>
          <span>Include breakdown</span>
        </label>
        <label style="display:flex; gap:8px; align-items:center; margin:6px 0;">
          <input type="checkbox" id="qt20-timestamp" ${g.includeTimestamp?"checked":""}>
          <span>Include timestamp</span>
        </label>
        <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" id="qt20-close" style="padding:4px 8px;">Close</button>
        </div>
      `,i.addEventListener("click",s=>{s.preventDefault(),u.style.display==="none"?h():p()}),i.addEventListener("mouseenter",()=>{i.style.filter="brightness(1.08)",i.style.transform="rotate(15deg)"}),i.addEventListener("mouseleave",()=>{i.style.filter="",i.style.transform=""}),i.addEventListener("focus",()=>{i.style.outline="2px solid #4a90e2",i.style.outlineOffset="2px"}),i.addEventListener("blur",()=>{i.style.outline="",i.style.outlineOffset=""}),u.querySelector("#qt20-close")?.addEventListener("click",p),u.querySelector("#qt20-breakdown")?.addEventListener("change",s=>{let d=b();O({...d,includeBreakdown:!!s.target.checked})}),u.querySelector("#qt20-timestamp")?.addEventListener("change",s=>{let d=b();O({...d,includeTimestamp:!!s.target.checked})}),a.appendChild(i),t.appendChild(a),(e.querySelector(".plex-dialog-content")||e).appendChild(u),Q(e,()=>{let s=typeof window<"u"?window:typeof globalThis<"u"?globalThis:null,d=s&&"CustomEvent"in s?s.CustomEvent:globalThis.CustomEvent;if(s&&s.dispatchEvent&&d)try{s.dispatchEvent(new d("LT:AttachmentRefreshRequested",{detail:{source:"QT20",ts:Date.now()}}))}catch{}})}catch(e){x("inject:",e)}}let E="qt20-stock-btn";function V(){return(document.querySelector(".plex-dialog-has-buttons .plex-dialog-title")?.textContent||"").trim().replace(/\s+/g," ")}function j(){return document.body.classList.contains("modal-open")&&/^quote\s*part\s*detail$/i.test(V())}function G(){return document.querySelector(".plex-dialog-has-buttons")||document.querySelector(".plex-dialog")}async function H(){try{await window.ensureLTHub?.()}catch{}let t=lt?.core?.hub;!t||!t.registerButton||t.has?.(E)||t.registerButton({id:E,label:"Stock",title:"Fetch stock for current part",section:"left",weight:110,onClick:()=>T(G())})}function W(){lt?.core?.hub?.remove?.(E)}function Y(t,e=50){let o=null;return(...r)=>{clearTimeout(o),o=setTimeout(()=>t(...r),e)}}let v=Y(async()=>{j()?await H():W()},50),y=null,U=null,_=!1;function J(t){U?.(),U=window.TMUtils?.onUrlChange?.(t)}function X(){y?.(),y=window.TMUtils?.observeInsertMany?.(c.ACTIONS_UL_SEL,z)}function Z(){try{y?.()}catch{}finally{y=null}}async function q(){if(_)return;_=!0,await A(),await L(),X(),v(),new MutationObserver(r=>{r.some(l=>l.type==="attributes")&&v()}).observe(document.body,{attributes:!0,attributeFilter:["class"]});let e=document.querySelector(".plex-dialog-has-buttons")||document.body;new MutationObserver(()=>v()).observe(e,{subtree:!0,childList:!0,characterData:!0}),S("initialized")}function tt(){_=!1,Z()}J(()=>{window.TMUtils?.matchRoute?.(k)?q():tt()}),q()})();})();
