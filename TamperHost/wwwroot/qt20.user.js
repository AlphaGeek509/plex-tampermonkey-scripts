// ==UserScript==
// @name        QT20
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     4.2.4
// @description Adds “Get Stock Levels” on Quote Part Detail and Hub; queries DS 172, normalizes to pieces, and toasts totals. Optionally stamps NoteNew with “Stock: N pcs”.
// @author      Jeff Nichols (OneMonroe | Lyn-Tron)
// @license     MIT
// @homepageURL https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @supportURL  https://github.com/AlphaGeek509/plex-tampermonkey-scripts/issues
// @match       https://lyntron.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.on.plex.com/SalesAndCrm/QuoteWizard*
// @match       https://lyntron.test.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.test.on.plex.com/SalesAndCrm/QuoteWizard*
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-plex-tm-utils.user.js?v=4.2.4
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-plex-auth.user.js?v=4.2.4
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-ui-hub.js?v=4.2.4
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-core.user.js?v=4.2.4
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-data-core.user.js?v=4.2.4
// @resource    THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @connect     cdn.jsdelivr.net
// @run-at      document-start
// @noframes
// @grant       GM_addStyle
// @grant       GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/qt20.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/qt20.user.js
// ==/UserScript==

(()=>{(()=>{"use strict";let p=(...t)=>!1,S=(...t)=>console.error("QT20 \u2716\uFE0F",...t),m=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko,I=()=>new Promise(t=>requestAnimationFrame(t));(!("__LT_HUB_MOUNT"in window)||!window.__LT_HUB_MOUNT)&&(window.__LT_HUB_MOUNT="nav"),(async()=>{try{await window.ensureLTHub?.({mount:window.__LT_HUB_MOUNT})}catch{}})();let M=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i];if(!M.some(t=>t.test(location.pathname)))return;let d={ACTIONS_UL_SEL:".plex-dialog-has-buttons .plex-actions-wrapper ul.plex-actions",MODAL_TITLE:"Quote Part Detail",ANCHOR_SEL:".plex-form-content",DS_STOCK:172,ACTION_BAR_SEL:"#QuoteWizardSharedActionBar",GRID_SEL:".plex-grid",POLL_MS:200,TIMEOUT_MS:12e3};async function N(){let t=document.querySelector(d.GRID_SEL)?d.GRID_SEL:d.ACTION_BAR_SEL;if(window.TMUtils?.waitForModelAsync){let{viewModel:o}=await window.TMUtils.waitForModelAsync(t,{pollMs:d.POLL_MS,timeoutMs:d.TIMEOUT_MS,requireKo:!0})??{viewModel:null};if(o)return o}let e=document.querySelector(".plex-wizard, .plex-page");return e&&(m?.dataFor?.(e)||null)}function A(t){try{let e=n=>t?.querySelector(n),o=e(".plex-form-content")||e(".plex-dialog-content")||e("[data-bind]")||t,c=m?.contextFor?.(o)||m?.contextFor?.(t)||null,i=c?.$data||c?.$root?.data||null;return i&&(i.data||i.model)?i.data||i.model:i}catch{return null}}let D=t=>{let e=lt?.core?.auth?.withFreshAuth;return typeof e=="function"?e(t):t()};function _(t){let e=String(t||"").trim(),o=e.match(/^(.*?)-(\d+)\s*(BAG|BOX|PACK|PKG)$/i);return o?{base:o[1],packSize:Number(o[2]),packUnit:o[3].toUpperCase()}:{base:e,packSize:null,packUnit:null}}function E(t){return _(t).base}function F(t,e){let o=String(t?.Part_No||"").trim(),{base:c,packSize:i}=_(o);if(!c||c!==e)return 0;let n=String(t?.Unit||"").toLowerCase(),r=Number(t?.Quantity)||0;return n===""||n==="pcs"||n==="piece"||n==="pieces"?r:i?r*i:r}function R(t,e){let o=new Map,c=0;for(let n of t||[]){let r=F(n,e);if(!r)continue;let a=String(n?.Location||n?.Warehouse||n?.Site||"UNK").trim();c+=r,o.set(a,(o.get(a)||0)+r)}let i=[...o].map(([n,r])=>({loc:n,qty:r})).sort((n,r)=>r.qty-n.qty);return{sum:c,breakdown:i}}let w=t=>Number(t).toLocaleString("en-US",{maximumFractionDigits:0});function ot(t){let e=o=>String(o).padStart(2,"0");return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}`}async function T(t){let e=lt.core.hub.beginTask("Fetching stock\u2026","info");try{let o=await N(),c=Number(lt?.core?.qt?.getQuoteContext?.()?.quoteKey||0);if(!Number.isFinite(c)||c<=0){let l=/[?&]QuoteKey=(\d+)/i.exec(location.search);c=l?Number(l[1]):0}if(!Number.isFinite(c)||c<=0)throw new Error("Quote Key not found");let i=A(t);if(!i&&window.TMUtils?.waitForModelAsync)try{let{viewModel:l}=await window.TMUtils.waitForModelAsync(".plex-dialog-has-buttons .plex-form-content",{pollMs:120,timeoutMs:1500,requireKo:!0})??{};l&&(i=l.data||l.model||l)}catch{}let n=await $(t,i??o,{timeoutMs:5e3,pollMs:150});if(!n)throw new Error("PartNo not available");let r=E(n),a=typeof getPlexFacade=="function"?await getPlexFacade():window.lt?.core?.plex??window.TMUtils,u=await D(()=>a.dsRows(d.DS_STOCK,{Part_No:r,Shippable:"TRUE",Container_Status:"OK"})),{sum:s}=R(u||[],r),g=[`STK: ${w(s)} pcs`],L=window.TMUtils?.getObsValue?.(i,"NoteNew",{trim:!0})||"",O=(/^(null|undefined)$/i.test(L)?"":L).replace(/(?:^|\s)(?:STK:\s*\d[\d,]*(?:\s*pcs)?(?:\s*\([^()]*\))?(?:\s*@\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})?|Stock:\s*\d[\d,]*\s*pcs)\s*/gi,"").trim(),q=`Stock: ${w(s)} pcs`,U=O?`${O} ${q}`:q,C=window.TMUtils?.setObsValue?.(i,"NoteNew",U);if(!C){let l=t?.querySelector('textarea[name="NoteNew"]');l&&(l.value=U,l.dispatchEvent(new Event("input",{bubbles:!0})),C=!0)}e.success("Stock retrieved",1200),lt.core.hub.notify(`Stock: ${w(s)} pcs`,"success",{toast:!0}),p("QT20 success",{qk:c,partNo:n,basePart:r,sum:s})}catch(o){e.error("Failed"),lt.core.hub.notify(`Stock check failed: ${o?.message||o}`,"error",{toast:!0}),S("handleClick:",o)}finally{}}function B(t,e){let o=["PartNo","ItemNo","Part_Number","Item_Number","Part","Item","PartNoNew","PartNoOld","QuotePart.PartNo","QuotePart.Part_Number","SelectedRow.PartNo","Row.PartNo","Model.PartNo","data.PartNo","data.ItemNo","model.PartNo","model.ItemNo"],c=window.TMUtils;if(e){let n=c?.getObsValue?.(e,o,{first:!0,trim:!0,allowPlex:!0});if(n)return n}let i=c?.getObsValue?.(t,o,{first:!0,trim:!0,allowPlex:!0});if(i)return i;try{let r=(t?.querySelector('input[name="PartNo"],input[name="Part_Number"],input[name="ItemNo"],input[name="Item_Number"]')?.value??"").trim();if(r)return r}catch{}return""}async function $(t,e,{timeoutMs:o=5e3,pollMs:c=150}={}){let i=Date.now()+Math.max(500,o|0),n="";for(;Date.now()<i;){let r=B(t,e);if(r)return r;n=r||n;try{let a=t?.querySelector('input[name="PartNo"],input[name="Part_Number"],input[name="ItemNo"],input[name="Item_Number"]');a&&(a.dispatchEvent(new Event("change",{bubbles:!0})),a.dispatchEvent(new Event("blur",{bubbles:!0})))}catch{}await new Promise(a=>requestAnimationFrame(a)),await new Promise(a=>setTimeout(a,Math.max(50,c|0)))}return n}function z(t,e){try{let o=t.querySelector(".plex-grid-container .plex-grid-header thead");if(!o)return[];let c=[...o.querySelectorAll("th .plex-grid-header-inner-content abbr")],i=new Set;for(let n of e){let r=c.findIndex(a=>a&&a.textContent&&a.textContent.trim().toLowerCase()===String(n).trim().toLowerCase());r>=0&&i.add(r)}return[...i].sort((n,r)=>n-r)}catch{return[]}}function K(t,e){if(!(!e||!e.length))try{let o=t.querySelectorAll(".plex-grid-container .plex-grid-header thead th");e.forEach(n=>{o[n]&&(o[n].style.display="none")});let c=t.querySelectorAll(".plex-grid-wrapper .plex-grid tbody tr");for(let n of c){let r=n.children;e.forEach(a=>{r&&r[a]&&(r[a].style.display="none")})}let i=t.querySelectorAll(".plex-grid-container colgroup, .plex-grid-wrapper colgroup");for(let n of i){let r=n.querySelectorAll("col");e.forEach(a=>{r[a]&&(r[a].style.display="none")})}}catch{}}function Q(t,e){try{let c=["NewUnitPrice","NewPercentMarkup","PercentMarkup","MarkupPercent"].map(u=>`input[name="${u}"],textarea[name="${u}"],select[name="${u}"]`).join(","),i=u=>{try{"readOnly"in u&&(u.readOnly=!0),"disabled"in u&&(u.disabled=!0),u.setAttribute("aria-readonly","true"),u.title="Disabled by policy",u.style.pointerEvents="none"}catch{}};try{t.querySelectorAll(c).forEach(i)}catch{}let n=new Set(e),r=u=>{let s=u?.closest?.("td");return!s||typeof s.cellIndex!="number"?!1:n.has(s.cellIndex)};t.dataset.qt20LockoutListeners||(t.dataset.qt20LockoutListeners="1",t.addEventListener("focusin",u=>{let s=u.target;if(s&&(r(s)||s.matches&&s.matches(c))){try{s.blur?.()}catch{}lt?.core?.hub?.notify?.("This field is controlled by policy and cannot be edited here.","warning",{toast:!0})}},!0),t.addEventListener("keydown",u=>{let s=u.target;s&&(r(s)||s.matches&&s.matches(c))&&(u.stopImmediatePropagation(),u.preventDefault())},!0),t.addEventListener("input",u=>{let s=u.target;s&&(r(s)||s.matches&&s.matches(c))&&("value"in s&&(s.value=""),u.stopImmediatePropagation(),u.preventDefault())},!0));let a=t.querySelectorAll(".plex-grid-wrapper .plex-grid tbody tr");for(let u of a)e.forEach(s=>{let g=u.children?.[s];g&&g.querySelectorAll("input,textarea,select").forEach(i)})}catch{}}function v(t){let e=z(t,["Unit Price","% Markup","$ Markup"]);Q(t,e),K(t,e)}function V(t){try{v(t);let e=t.querySelector(".plex-grid-container")||t,o=new MutationObserver(()=>v(t));o.observe(e,{childList:!0,subtree:!0}),x(t,()=>o.disconnect())}catch{}}function x(t,e){if(!t||!t.ownerDocument)return()=>{};let o=new MutationObserver(c=>{for(let i of c)for(let n of i.removedNodes||[])if(n===t||n.contains&&n.contains(t)){try{e()}finally{o.disconnect()}return}});return o.observe(t.ownerDocument.body,{childList:!0,subtree:!0}),()=>o.disconnect()}function H(t){try{let e=t.closest(".plex-dialog");if(!(e?.querySelector(".plex-dialog-title")?.textContent?.trim()===d.MODAL_TITLE)||t.dataset.qt20Injected)return;t.dataset.qt20Injected="1",p("injecting controls");let i=document.createElement("li");i.className="lt-action lt-action--brand";let n=document.createElement("a");n.href="javascript:void(0)",n.id="qt20-stock-li-btn",n.className="lt-btn lt-btn--ghost",n.textContent="Get Stock Levels",n.title="Fetch stock for this part (no stamp)",n.addEventListener("click",r=>{r.preventDefault(),T(e)}),i.appendChild(n),t.appendChild(i),V(e),x(e,()=>{let r=typeof window<"u"?window:typeof globalThis<"u"?globalThis:null,a=r&&"CustomEvent"in r?r.CustomEvent:globalThis.CustomEvent;if(r&&r.dispatchEvent&&a)try{r.dispatchEvent(new a("LT:AttachmentRefreshRequested",{detail:{source:"QT20",ts:Date.now()}}))}catch{}})}catch(e){S("inject:",e)}}let h="qt20-stock-btn";function j(){return(document.querySelector(".plex-dialog-has-buttons .plex-dialog-title")?.textContent||"").trim().replace(/\s+/g," ")}function G(){return document.body.classList.contains("modal-open")&&/^quote\s*part\s*detail$/i.test(j())}function W(){return document.querySelector(".plex-dialog-has-buttons")||document.querySelector(".plex-dialog")}async function X(){try{await window.ensureLTHub?.()}catch{}let t=lt?.core?.hub;!t||!t.registerButton||t.has?.(h)||t.registerButton("left",{id:h,label:"Stock",title:"Fetch stock for current part",weight:110,onClick:()=>T(W())})}function Y(){lt?.core?.hub?.remove?.(h)}function J(t,e=50){let o=null;return(...c)=>{clearTimeout(o),o=setTimeout(()=>t(...c),e)}}let b=J(async()=>{G()?await X():Y()},50),f=null,k=null,y=!1;function Z(t){k?.(),k=window.TMUtils?.onUrlChange?.(t)}function tt(){f?.(),f=window.TMUtils?.observeInsertMany?.(d.ACTIONS_UL_SEL,H)}function et(){try{f?.()}catch{}finally{f=null}}async function P(){if(y)return;y=!0,await I(),await N(),tt(),b(),new MutationObserver(c=>{c.some(i=>i.type==="attributes")&&b()}).observe(document.body,{attributes:!0,attributeFilter:["class"]});let e=document.querySelector(".plex-dialog-has-buttons")||document.body;new MutationObserver(()=>b()).observe(e,{subtree:!0,childList:!0,characterData:!0}),p("initialized")}function nt(){y=!1,et()}Z(()=>{window.TMUtils?.matchRoute?.(M)?P():nt()}),P()})();})();
