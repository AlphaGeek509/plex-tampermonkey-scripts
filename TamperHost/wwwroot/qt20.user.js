// ==UserScript==
// @name        QT20
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     3.8.100
// @description Production build
// @match       https://lyntron.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.on.plex.com/SalesAndCrm/QuoteWizard*
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-plex-tm-utils.user.js?v=3.8.100
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-plex-auth.user.js?v=3.8.100
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-ui-hub.js?v=3.8.100
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-data-core.user.js?v=3.8.100
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-core.user.js?v=3.8.100
// @resource     THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @run-at      document-start
// @noframes
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt20.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt20.user.js
// ==/UserScript==

(()=>{(()=>{"use strict";let m=(...t)=>!1,N=(...t)=>console.error("QT20 \u2716\uFE0F",...t),f=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko,x=()=>new Promise(t=>requestAnimationFrame(t));(!("__LT_HUB_MOUNT"in window)||!window.__LT_HUB_MOUNT)&&(window.__LT_HUB_MOUNT="nav"),(async()=>{try{await window.ensureLTHub?.({mount:window.__LT_HUB_MOUNT})}catch{}})();let _=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i];if(!_.some(t=>t.test(location.pathname)))return;let a={ACTIONS_UL_SEL:".plex-dialog-has-buttons .plex-actions-wrapper ul.plex-actions",MODAL_TITLE:"Quote Part Detail",ANCHOR_SEL:'.plex-form-content, .plex-dialog-content, [data-bind], input[name="PartNo"], input[name="PartNoNew"], input[name="ItemNo"], input[name="Part_Number"], input[name="Item_Number"]',DS_STOCK:172,ACTION_BAR_SEL:"#QuoteWizardSharedActionBar",GRID_SEL:".plex-grid",POLL_MS:200,TIMEOUT_MS:12e3};async function S(){let t=document.querySelector(a.GRID_SEL)?a.GRID_SEL:a.ACTION_BAR_SEL;if(window.TMUtils?.waitForModelAsync){let{viewModel:n}=await window.TMUtils.waitForModelAsync(t,{pollMs:a.POLL_MS,timeoutMs:a.TIMEOUT_MS,requireKo:!0})??{viewModel:null};if(n)return n}let o=document.querySelector(".plex-wizard, .plex-page");return o&&(f?.dataFor?.(o)||null)}function U(t){try{let o=e=>t?.querySelector(e),n=o(".plex-form-content")||o(".plex-dialog-content")||o("[data-bind]")||t,i=f?.contextFor?.(n)||f?.contextFor?.(t)||null,s=i?.$data||i?.$root?.data||null;return s&&(s.data||s.model)?s.data||s.model:s}catch{return null}}let E=t=>{let o=lt?.core?.auth?.withFreshAuth;return typeof o=="function"?o(t):t()};function T(t){let o=String(t||"").trim(),n=o.match(/^(.*?)-(\d+)\s*(BAG|BOX|PACK|PKG)$/i);return n?{base:n[1],packSize:Number(n[2]),packUnit:n[3].toUpperCase()}:{base:o,packSize:null,packUnit:null}}function C(t){return T(t).base}function I(t,o){let n=String(t?.Part_No||"").trim(),{base:i,packSize:s}=T(n);if(!i||i!==o)return 0;let e=String(t?.Unit||"").toLowerCase(),r=Number(t?.Quantity)||0;return e===""||e==="pcs"||e==="piece"||e==="pieces"?r:s?r*s:r}function A(t,o){let n=new Map,i=0;for(let e of t||[]){let r=I(e,o);if(!r)continue;let c=String(e?.Location||e?.Warehouse||e?.Site||"UNK").trim();i+=r,n.set(c,(n.get(c)||0)+r)}let s=[...n].map(([e,r])=>({loc:e,qty:r})).sort((e,r)=>r.qty-e.qty);return{sum:i,breakdown:s}}let w=t=>Number(t).toLocaleString("en-US",{maximumFractionDigits:0});function X(t){let o=n=>String(n).padStart(2,"0");return`${t.getFullYear()}-${o(t.getMonth()+1)}-${o(t.getDate())} ${o(t.getHours())}:${o(t.getMinutes())}`}async function b(t){let o=lt.core.hub.beginTask("Fetching stock\u2026","info");try{let n=await S(),i=Number(lt?.core?.qt?.getQuoteContext?.()?.quoteKey||0);if(!Number.isFinite(i)||i<=0){let u=/[?&]QuoteKey=(\d+)/i.exec(location.search);i=u?Number(u[1]):0}if(!Number.isFinite(i)||i<=0)throw new Error("Quote Key not found");let s=U(t),e=D(t,s??n);if(!e)throw new Error("PartNo not available");let r=C(e),c=typeof getPlexFacade=="function"?await getPlexFacade():window.lt?.core?.plex??window.TMUtils,W=await E(()=>c.dsRows(a.DS_STOCK,{Part_No:r,Shippable:"TRUE",Container_Status:"OK"})),{sum:d}=A(W||[],r),Y=[`STK: ${w(d)} pcs`],v=window.TMUtils?.getObsValue?.(s,"NoteNew",{trim:!0})||"",k=(/^(null|undefined)$/i.test(v)?"":v).replace(/(?:^|\s)(?:STK:\s*\d[\d,]*(?:\s*pcs)?(?:\s*\([^()]*\))?(?:\s*@\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})?|Stock:\s*\d[\d,]*\s*pcs)\s*/gi,"").trim(),L=`Stock: ${w(d)} pcs`,O=k?`${k} ${L}`:L,P=window.TMUtils?.setObsValue?.(s,"NoteNew",O);if(!P){let u=t?.querySelector('textarea[name="NoteNew"]');u&&(u.value=O,u.dispatchEvent(new Event("input",{bubbles:!0})),P=!0)}o.success("Stock retrieved",1200),lt.core.hub.notify(`Stock: ${w(d)} pcs`,"success",{ms:2500,toast:!0}),m("QT20 success",{qk:i,partNo:e,basePart:r,sum:d})}catch(n){o.error("Failed"),lt.core.hub.notify(`Stock check failed: ${n?.message||n}`,"error",{ms:4e3,toast:!0}),N("handleClick:",n)}finally{}}function D(t,o){let n=["PartNo","ItemNo","Part_Number","Item_Number","Part","Item","PartNoNew","PartNoOld","QuotePart.PartNo","QuotePart.Part_Number","SelectedRow.PartNo","Row.PartNo","Model.PartNo","data.PartNo","data.ItemNo","model.PartNo","model.ItemNo"],i=window.TMUtils;if(o){let e=i?.getObsValue?.(o,n,{first:!0,trim:!0,allowPlex:!0});if(e)return e}let s=i?.getObsValue?.(t,n,{first:!0,trim:!0,allowPlex:!0});if(s)return s;try{let r=(t?.querySelector('input[name="PartNo"],input[name="Part_Number"],input[name="ItemNo"],input[name="Item_Number"]')?.value??"").trim();if(r)return r}catch{}return""}function q(t,o){if(!t||!t.ownerDocument)return()=>{};let n=new MutationObserver(i=>{for(let s of i)for(let e of s.removedNodes||[])if(e===t||e.contains&&e.contains(t)){try{o()}finally{n.disconnect()}return}});return n.observe(t.ownerDocument.body,{childList:!0,subtree:!0}),()=>n.disconnect()}function B(t){try{let o=t.closest(".plex-dialog");if(!(o?.querySelector(".plex-dialog-title")?.textContent?.trim()===a.MODAL_TITLE)||t.dataset.qt20Injected)return;t.dataset.qt20Injected="1",m("injecting controls");let s=document.createElement("li"),e=document.createElement("a");e.href="javascript:void(0)",e.textContent="LT Get Stock Levels",e.title="Show total stock (no stamp)",e.setAttribute("aria-label","Get stock levels"),e.setAttribute("role","button"),Object.assign(e.style,{cursor:"pointer",transition:"filter .15s, text-decoration-color .15s"}),e.addEventListener("mouseenter",()=>{e.style.filter="brightness(1.08)",e.style.textDecoration="underline"}),e.addEventListener("mouseleave",()=>{e.style.filter="",e.style.textDecoration=""}),e.addEventListener("focus",()=>{e.style.outline="2px solid #4a90e2",e.style.outlineOffset="2px"}),e.addEventListener("blur",()=>{e.style.outline="",e.style.outlineOffset=""}),e.addEventListener("click",()=>b(o)),e.addEventListener("keydown",r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),b(o))}),s.appendChild(e),t.appendChild(s),q(o,()=>{let r=typeof window<"u"?window:typeof globalThis<"u"?globalThis:null,c=r&&"CustomEvent"in r?r.CustomEvent:globalThis.CustomEvent;if(r&&r.dispatchEvent&&c)try{r.dispatchEvent(new c("LT:AttachmentRefreshRequested",{detail:{source:"QT20",ts:Date.now()}}))}catch{}})}catch(o){N("inject:",o)}}let p="qt20-stock-btn";function R(){return(document.querySelector(".plex-dialog-has-buttons .plex-dialog-title")?.textContent||"").trim().replace(/\s+/g," ")}function F(){return document.body.classList.contains("modal-open")&&/^quote\s*part\s*detail$/i.test(R())}function $(){return document.querySelector(".plex-dialog-has-buttons")||document.querySelector(".plex-dialog")}async function z(){try{await window.ensureLTHub?.()}catch{}let t=lt?.core?.hub;!t||!t.registerButton||t.has?.(p)||t.registerButton("left",{id:p,label:"Stock",title:"Fetch stock for current part",weight:110,onClick:()=>b($())})}function Q(){lt?.core?.hub?.remove?.(p)}function V(t,o=50){let n=null;return(...i)=>{clearTimeout(n),n=setTimeout(()=>t(...i),o)}}let h=V(async()=>{F()?await z():Q()},50),l=null,g=null,y=!1;function K(t){g?.(),g=window.TMUtils?.onUrlChange?.(t)}function H(){l?.(),l=window.TMUtils?.observeInsertMany?.(a.ACTIONS_UL_SEL,B)}function j(){try{l?.()}catch{}finally{l=null}}async function M(){if(y)return;y=!0,await x(),await S(),H(),h(),new MutationObserver(i=>{i.some(s=>s.type==="attributes")&&h()}).observe(document.body,{attributes:!0,attributeFilter:["class"]});let o=document.querySelector(".plex-dialog-has-buttons")||document.body;new MutationObserver(()=>h()).observe(o,{subtree:!0,childList:!0,characterData:!0}),m("initialized")}function G(){y=!1,j()}K(()=>{window.TMUtils?.matchRoute?.(_)?M():G()}),M()})();})();
