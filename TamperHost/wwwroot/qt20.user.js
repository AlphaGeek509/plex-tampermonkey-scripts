// ==UserScript==
// @name        QT20
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     4.0.1
// @description Adds “Get Stock Levels” on Quote Part Detail and Hub; queries DS 172, normalizes to pieces, and toasts totals. Optionally stamps NoteNew with “Stock: N pcs”.
// @author      Jeff Nichols (OneMonroe | Lyn-Tron)
// @license     MIT
// @homepageURL https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @supportURL  https://github.com/AlphaGeek509/plex-tampermonkey-scripts/issues
// @match       https://lyntron.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.on.plex.com/SalesAndCrm/QuoteWizard*
// @match       https://lyntron.test.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.test.on.plex.com/SalesAndCrm/QuoteWizard*
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-plex-tm-utils.user.js?v=4.0.1
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-plex-auth.user.js?v=4.0.1
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-ui-hub.js?v=4.0.1
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-data-core.user.js?v=4.0.1
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-core.user.js?v=4.0.1
// @resource    THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @connect     cdn.jsdelivr.net
// @run-at      document-start
// @noframes
// @grant       GM_addStyle
// @grant       GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt20.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt20.user.js
// ==/UserScript==

(()=>{(()=>{"use strict";let m=(...t)=>!1,_=(...t)=>console.error("QT20 \u2716\uFE0F",...t),f=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko,U=()=>new Promise(t=>requestAnimationFrame(t));(!("__LT_HUB_MOUNT"in window)||!window.__LT_HUB_MOUNT)&&(window.__LT_HUB_MOUNT="nav"),(async()=>{try{await window.ensureLTHub?.({mount:window.__LT_HUB_MOUNT})}catch{}})();let S=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i];if(!S.some(t=>t.test(location.pathname)))return;let a={ACTIONS_UL_SEL:".plex-dialog-has-buttons .plex-actions-wrapper ul.plex-actions",MODAL_TITLE:"Quote Part Detail",ANCHOR_SEL:".plex-form-content",DS_STOCK:172,ACTION_BAR_SEL:"#QuoteWizardSharedActionBar",GRID_SEL:".plex-grid",POLL_MS:200,TIMEOUT_MS:12e3};async function N(){let t=document.querySelector(a.GRID_SEL)?a.GRID_SEL:a.ACTION_BAR_SEL;if(window.TMUtils?.waitForModelAsync){let{viewModel:o}=await window.TMUtils.waitForModelAsync(t,{pollMs:a.POLL_MS,timeoutMs:a.TIMEOUT_MS,requireKo:!0})??{viewModel:null};if(o)return o}let e=document.querySelector(".plex-wizard, .plex-page");return e&&(f?.dataFor?.(e)||null)}function x(t){try{let e=n=>t?.querySelector(n),o=e(".plex-form-content")||e(".plex-dialog-content")||e("[data-bind]")||t,s=f?.contextFor?.(o)||f?.contextFor?.(t)||null,i=s?.$data||s?.$root?.data||null;return i&&(i.data||i.model)?i.data||i.model:i}catch{return null}}let C=t=>{let e=lt?.core?.auth?.withFreshAuth;return typeof e=="function"?e(t):t()};function y(t){let e=String(t||"").trim(),o=e.match(/^(.*?)-(\d+)\s*(BAG|BOX|PACK|PKG)$/i);return o?{base:o[1],packSize:Number(o[2]),packUnit:o[3].toUpperCase()}:{base:e,packSize:null,packUnit:null}}function E(t){return y(t).base}function I(t,e){let o=String(t?.Part_No||"").trim(),{base:s,packSize:i}=y(o);if(!s||s!==e)return 0;let n=String(t?.Unit||"").toLowerCase(),r=Number(t?.Quantity)||0;return n===""||n==="pcs"||n==="piece"||n==="pieces"?r:i?r*i:r}function q(t,e){let o=new Map,s=0;for(let n of t||[]){let r=I(n,e);if(!r)continue;let c=String(n?.Location||n?.Warehouse||n?.Site||"UNK").trim();s+=r,o.set(c,(o.get(c)||0)+r)}let i=[...o].map(([n,r])=>({loc:n,qty:r})).sort((n,r)=>r.qty-n.qty);return{sum:s,breakdown:i}}let w=t=>Number(t).toLocaleString("en-US",{maximumFractionDigits:0});function X(t){let e=o=>String(o).padStart(2,"0");return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}`}async function T(t){let e=lt.core.hub.beginTask("Fetching stock\u2026","info");try{let o=await N(),s=Number(lt?.core?.qt?.getQuoteContext?.()?.quoteKey||0);if(!Number.isFinite(s)||s<=0){let u=/[?&]QuoteKey=(\d+)/i.exec(location.search);s=u?Number(u[1]):0}if(!Number.isFinite(s)||s<=0)throw new Error("Quote Key not found");let i=x(t),n=A(t,i??o);if(!n)throw new Error("PartNo not available");let r=E(n),c=typeof getPlexFacade=="function"?await getPlexFacade():window.lt?.core?.plex??window.TMUtils,W=await C(()=>c.dsRows(a.DS_STOCK,{Part_No:r,Shippable:"TRUE",Container_Status:"OK"})),{sum:d}=q(W||[],r),Y=[`STK: ${w(d)} pcs`],k=window.TMUtils?.getObsValue?.(i,"NoteNew",{trim:!0})||"",v=(/^(null|undefined)$/i.test(k)?"":k).replace(/(?:^|\s)(?:STK:\s*\d[\d,]*(?:\s*pcs)?(?:\s*\([^()]*\))?(?:\s*@\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})?|Stock:\s*\d[\d,]*\s*pcs)\s*/gi,"").trim(),O=`Stock: ${w(d)} pcs`,P=v?`${v} ${O}`:O,L=window.TMUtils?.setObsValue?.(i,"NoteNew",P);if(!L){let u=t?.querySelector('textarea[name="NoteNew"]');u&&(u.value=P,u.dispatchEvent(new Event("input",{bubbles:!0})),L=!0)}e.success("Stock retrieved",1200),lt.core.hub.notify(`Stock: ${w(d)} pcs`,"success",{toast:!0}),m("QT20 success",{qk:s,partNo:n,basePart:r,sum:d})}catch(o){e.error("Failed"),lt.core.hub.notify(`Stock check failed: ${o?.message||o}`,"error",{toast:!0}),_("handleClick:",o)}finally{}}function A(t,e){let o=["PartNo","ItemNo","Part_Number","Item_Number","Part","Item","PartNoNew","PartNoOld","QuotePart.PartNo","QuotePart.Part_Number","SelectedRow.PartNo","Row.PartNo","Model.PartNo","data.PartNo","data.ItemNo","model.PartNo","model.ItemNo"],s=window.TMUtils;if(e){let n=s?.getObsValue?.(e,o,{first:!0,trim:!0,allowPlex:!0});if(n)return n}let i=s?.getObsValue?.(t,o,{first:!0,trim:!0,allowPlex:!0});if(i)return i;try{let r=(t?.querySelector('input[name="PartNo"],input[name="Part_Number"],input[name="ItemNo"],input[name="Item_Number"]')?.value??"").trim();if(r)return r}catch{}return""}function D(t,e){if(!t||!t.ownerDocument)return()=>{};let o=new MutationObserver(s=>{for(let i of s)for(let n of i.removedNodes||[])if(n===t||n.contains&&n.contains(t)){try{e()}finally{o.disconnect()}return}});return o.observe(t.ownerDocument.body,{childList:!0,subtree:!0}),()=>o.disconnect()}function B(t){try{let e=t.closest(".plex-dialog");if(!(e?.querySelector(".plex-dialog-title")?.textContent?.trim()===a.MODAL_TITLE)||t.dataset.qt20Injected)return;t.dataset.qt20Injected="1",m("injecting controls");let i=document.createElement("li");i.className="lt-action lt-action--brand";let n=document.createElement("a");n.href="javascript:void(0)",n.id="qt20-stock-li-btn",n.className="lt-btn lt-btn--ghost",n.textContent="Get Stock Levels",n.title="Fetch stock for this part (no stamp)",n.addEventListener("click",r=>{r.preventDefault(),T(e)}),i.appendChild(n),t.appendChild(i),D(e,()=>{let r=typeof window<"u"?window:typeof globalThis<"u"?globalThis:null,c=r&&"CustomEvent"in r?r.CustomEvent:globalThis.CustomEvent;if(r&&r.dispatchEvent&&c)try{r.dispatchEvent(new c("LT:AttachmentRefreshRequested",{detail:{source:"QT20",ts:Date.now()}}))}catch{}})}catch(e){_("inject:",e)}}let b="qt20-stock-btn";function R(){return(document.querySelector(".plex-dialog-has-buttons .plex-dialog-title")?.textContent||"").trim().replace(/\s+/g," ")}function F(){return document.body.classList.contains("modal-open")&&/^quote\s*part\s*detail$/i.test(R())}function $(){return document.querySelector(".plex-dialog-has-buttons")||document.querySelector(".plex-dialog")}async function z(){try{await window.ensureLTHub?.()}catch{}let t=lt?.core?.hub;!t||!t.registerButton||t.has?.(b)||t.registerButton("left",{id:b,label:"Stock",title:"Fetch stock for current part",weight:110,onClick:()=>T($())})}function Q(){lt?.core?.hub?.remove?.(b)}function V(t,e=50){let o=null;return(...s)=>{clearTimeout(o),o=setTimeout(()=>t(...s),e)}}let p=V(async()=>{F()?await z():Q()},50),l=null,g=null,h=!1;function K(t){g?.(),g=window.TMUtils?.onUrlChange?.(t)}function H(){l?.(),l=window.TMUtils?.observeInsertMany?.(a.ACTIONS_UL_SEL,B)}function j(){try{l?.()}catch{}finally{l=null}}async function M(){if(h)return;h=!0,await U(),await N(),H(),p(),new MutationObserver(s=>{s.some(i=>i.type==="attributes")&&p()}).observe(document.body,{attributes:!0,attributeFilter:["class"]});let e=document.querySelector(".plex-dialog-has-buttons")||document.body;new MutationObserver(()=>p()).observe(e,{subtree:!0,childList:!0,characterData:!0}),m("initialized")}function G(){h=!1,j()}K(()=>{window.TMUtils?.matchRoute?.(S)?M():G()}),M()})();})();
