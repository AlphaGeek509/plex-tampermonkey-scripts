// ==UserScript==
// @name        QT30
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     4.2.4
// @description Applies customer catalog breakpoints (DS 4809) using Catalog Key (repo/DS 3156), removes zero-qty rows, and sets RvCustomizedUnitPrice with rounding. Refreshes via KO or wizard nav.
// @author      Jeff Nichols (OneMonroe | Lyn-Tron)
// @license     MIT
// @homepageURL https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @supportURL  https://github.com/AlphaGeek509/plex-tampermonkey-scripts/issues
// @match       https://lyntron.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.on.plex.com/SalesAndCrm/QuoteWizard*
// @match       https://lyntron.test.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.test.on.plex.com/SalesAndCrm/QuoteWizard*
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-plex-tm-utils.user.js?v=4.2.4
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-plex-auth.user.js?v=4.2.4
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-ui-hub.js?v=4.2.4
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-core.user.js?v=4.2.4
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/lt-data-core.user.js?v=4.2.4
// @resource    THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @connect     cdn.jsdelivr.net
// @run-at      document-start
// @noframes
// @grant       GM_addStyle
// @grant       GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/qt30.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.2.4/TamperHost/wwwroot/qt30.user.js
// ==/UserScript==

(()=>{(async function(){let n={DS_CatalogKeyByQuoteKey:3156,DS_BreakpointsByPart:4809,GRID_SEL:".plex-grid",toastMs:3500,settingsKey:"qt30_settings_v1",SHOW_ON_PAGES_RE:/^part\s*summary$/i,PART_SUMMARY_STEP_INDEX:1,FORCE_SHOW_BTN:!1,defaults:{deleteZeroQtyRows:!0,unitPriceDecimals:3,enableHoverAffordance:!0}},w=/test\.on\.plex\.com$/i.test(location.hostname);TMUtils.setDebug?.(w);let Q=TMUtils.getLogger?.("QT30"),S=(...t)=>{w&&Q?.log?.(...t)},v=(...t)=>{w&&Q?.error?.(...t)},g=typeof unsafeWindow<"u"&&unsafeWindow.ko?unsafeWindow.ko:window.ko,D=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i];if(!D.some(t=>t.test(location.pathname))){S("QT30: wrong route, skipping");return}window.__LT_HUB_MOUNT="nav",(async()=>{try{await window.ensureLTHub?.({mount:"nav"})}catch{}lt.core.hub.notify("Ready","info",{sticky:!0})})();let d=null,l=null,K=null;async function V(){if(d)return d;let t=lt.core?.data;if(!t?.makeFlatScopedRepo)throw new Error("DataCore not ready");return d=t.makeFlatScopedRepo({ns:"QT",entity:"quote",legacyEntity:"QuoteHeader"}),d}async function E(t){if(!t)return null;if(!l||K!==t){let{repo:e}=(await V()).use(Number(t));await e.ensureFromLegacyIfMissing?.(),l=e,K=t}return l}let A=()=>{try{let t=GM_getValue(n.settingsKey,n.defaults);return typeof t=="string"?{...n.defaults,...JSON.parse(t)}:{...n.defaults,...t}}catch{return{...n.defaults}}},G=t=>{try{GM_setValue(n.settingsKey,t)}catch{GM_setValue(n.settingsKey,JSON.stringify(t))}},h=t=>{let e=lt?.core?.auth?.withFreshAuth;return typeof e=="function"?e(t):t()},p="qt30-apply-pricing",m=!1,_=null;function q(t){_?.(),_=window.TMUtils?.onUrlChange?.(t)}async function k(){m||(m=!0,await lt.core.qt.ensureHubButton({id:p,label:"Apply Pricing",title:"Apply customer catalog pricing",side:"left",weight:120,onClick:()=>N(),showWhen:()=>!0,mount:"nav"}),lt.core.qt.getHub({mount:"nav"}).then(t=>{let s=(Array.isArray(t?.list?.())?t.list():[]).map(a=>a&&typeof a=="object"?a.id:a).filter(Boolean);if(!(typeof t?.has=="function"?!!t.has(p):s.includes(p))&&typeof t?.registerButton=="function"){let a={id:p,label:"Apply Pricing",title:"Apply customer catalog pricing",weight:120,onClick:()=>N()};try{t.registerButton("left",a)}catch{}}}).catch(()=>{}))}function O(){m=!1,_?.(),_=null}k(),q(()=>{D.some(t=>t.test(location.pathname))?k():O()});async function N(){let t=lt.core.hub.beginTask("Applying catalog pricing\u2026","info");try{try{if(!await lt.core.auth.getKey()){lt.core.hub.notify("Sign-in required","warn"),t.error("No session");return}}catch{}let{quoteKey:e}=F()||{};if(!e){t.error("Quote_Key missing");return}await E(e);try{await lt.core.qt.promoteDraftToQuote?.({qk:e,strategy:"once"})}catch{}let s=await l.getHeader?.()||{},o=TMUtils.getObsValue?.(s,["Catalog_Key","CatalogKey"],{first:!0})??null;if(o==null)try{await lt.core.qt.promoteDraftToQuote?.({qk:e,strategy:"retry"}),s=await l.getHeader?.()||{},o=TMUtils.getObsValue?.(s,["Catalog_Key","CatalogKey"],{first:!0})??null}catch{}if(o==null&&(t.update("Fetching Catalog Key\u2026"),o=(await h(()=>lt.core.plex.dsRows(n.DS_CatalogKeyByQuoteKey,{Quote_Key:e})))?.[0]?.Catalog_Key||null,o&&await l.patchHeader?.({Quote_Key:Number(e),Catalog_Key:Number(o)})),o==null){t.error("No Catalog Key"),lt.core.hub.notify("No catalog found for this quote","warn");return}let a=document.querySelector(n.GRID_SEL),P=a&&g?.dataFor&&Array.isArray(g.dataFor(a)?.datasource?.raw)?g.dataFor(a).datasource.raw:[],T=[...new Set(P.map(r=>TMUtils.getObsValue?.(r,"PartNo",{first:!0,trim:!0})).filter(Boolean))];if(!T.length){t.error("No PartNo values"),lt.core.hub.notify("No PartNo values found","warn");return}t.update(`Loading ${T.length} part(s)\u2026`);let R=new Date,b={};await Promise.all(T.map(async r=>{let c=await h(()=>lt.core.plex.dsRows(n.DS_BreakpointsByPart,{Catalog_Key:o,Catalog_Part_No:r}))||[];b[r]=c.filter(i=>i.Catalog_Part_No===r&&new Date(i.Effective_Date)<=R&&R<=new Date(i.Expiration_Date)).sort((i,f)=>i.Breakpoint_Quantity-f.Breakpoint_Quantity)}));let B=A(),C=r=>+(+r).toFixed(B.unitPriceDecimals);for(let r=0;r<P.length;r++){let c=P[r],i=+(TMUtils.getObsValue(c,"Quantity",{first:!0,trim:!0})||0);if(i<=0&&B.deleteZeroQtyRows){let f=TMUtils.getObsValue(c,["QuoteKey","Quote_Key"],{first:!0,trim:!0}),y=TMUtils.getObsValue(c,["QuotePartKey","Quote_Part_Key"],{first:!0,trim:!0}),M=TMUtils.getObsValue(c,["QuotePriceKey","Quote_Price_Key"],{first:!0,trim:!0});if(f&&y&&M)try{let u=new URLSearchParams;u.set("QuoteKey",String(Number(f))),u.set("QuotePartKey",String(Number(y))),u.set("QuotePriceKey",String(Number(M)));let U=document.querySelector('input[name="__RequestVerificationToken"]')?.value||document.querySelector('meta[name="__RequestVerificationToken"]')?.content;U&&u.set("__RequestVerificationToken",U),await h(()=>lt.core.http.post("/SalesAndCRM/QuotePart/DeleteQuotePrice",u.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}})),lt.core.hub.notify(`Deleted row[${r}]`,"success")}catch(u){v("QT30 delete error",u),lt.core.hub.notify(`Delete failed row[${r}]`,"error")}else lt.core.hub.notify(`Skip delete row[${r}] \u2014 missing keys`,"warn");continue}if(i>0){let f=TMUtils.getObsValue(c,"PartNo",{first:!0,trim:!0}),y=H(b[f],i);if(y==null)continue;L(c,C(y)),S(`QT30: row[${r}] qty=${i} price=${C(y)}`)}}t.update("Refreshing grid\u2026");let I=await $();t.success("Pricing applied"),lt.core.hub.notify(I?"Pricing applied and grid refreshed":"Pricing applied (reload may be needed)","success")}catch(e){t.error("Failed"),lt.core.hub.notify(`Apply failed: ${e?.message||e}`,"error")}finally{}}let F=()=>lt?.core?.qt?.getQuoteContext();function H(t,e){if(!t?.length)return null;if(e<t[0].Breakpoint_Quantity)return t[0].Breakpoint_Price;let s=t[t.length-1];if(e>=s.Breakpoint_Quantity)return s.Breakpoint_Price;for(let o=0;o<t.length-1;o++)if(e>=t[o].Breakpoint_Quantity&&e<t[o+1].Breakpoint_Quantity)return t[o].Breakpoint_Price;return null}function L(t,e){TMUtils.setObsValue(t,"RvCustomizedUnitPrice",e)}async function $(){try{let t=document.querySelector(n.GRID_SEL),e=t&&g?.dataFor?.(t);if(typeof e?.datasource?.read=="function")return await e.datasource.read(),"ds.read";if(typeof e?.refresh=="function")return e.refresh(),"vm.refresh"}catch{}try{let t=unsafeWindow.plex?.currentPage?.QuoteWizard;if(t?.navigatePage){let e=typeof t.activePage=="function"?t.activePage():t.activePage;return t.navigatePage(e),"wiz.navigatePage"}}catch{}return null}})();})();
