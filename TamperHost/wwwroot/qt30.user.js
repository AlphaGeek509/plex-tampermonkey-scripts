// ==UserScript==
// @name        QT30
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     3.7.7
// @description Production build
// @match       https://lyntron.on.plex.com/SalesAndCRM*
// @match       https://lyntron.on.plex.com/SalesAndCrm*
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.7/wwwroot/lt-plex-tm-utils.user.js?v=3.7.7
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.7/wwwroot/lt-plex-auth.user.js?v=3.7.7
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.7/wwwroot/lt-ui-hub.js?v=3.7.7
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.7/wwwroot/lt-data-core.user.js?v=3.7.7
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.7/wwwroot/lt-core.user.js?v=3.7.7
// @resource     THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.7/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @run-at      document-start
// @noframes
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.7/wwwroot/qt30.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.7/wwwroot/qt30.user.js
// ==/UserScript==
(()=>{(()=>{let a={DS_CatalogKeyByQuoteKey:3156,DS_BreakpointsByPart:4809,GRID_SEL:".plex-grid",toastMs:3500,settingsKey:"qt30_settings_v1",SHOW_ON_PAGES_RE:/^part\s*summary$/i,FORCE_SHOW_BTN:!1,defaults:{deleteZeroQtyRows:!0,unitPriceDecimals:3,enableHoverAffordance:!0}},m=/test\.on\.plex\.com$/i.test(location.hostname);TMUtils.setDebug?.(m);let K=TMUtils.getLogger?.("QT30"),v=(...e)=>{m&&K?.log?.(...e)},U=(...e)=>{m&&K?.error?.(...e)},w=typeof unsafeWindow<"u"&&unsafeWindow.ko?unsafeWindow.ko:window.ko,N=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i];if(!N.some(e=>e.test(location.pathname))){v("QT30: wrong route, skipping");return}window.__LT_HUB_MOUNT="nav",(async()=>{try{await window.ensureLTHub?.({mount:"nav"})}catch{}lt.core.hub.notify("Ready","info",{sticky:!0})})();let p=null,y=null,k=null;async function C(){if(p)return p;let e=lt.core?.data;if(!e?.makeFlatScopedRepo)throw new Error("DataCore not ready");return p=e.makeFlatScopedRepo({ns:"QT",entity:"quote",legacyEntity:"QuoteHeader"}),p}async function F(e){if(!e)return null;if(!y||k!==e){let{repo:t}=(await C()).use(Number(e));await t.ensureFromLegacyIfMissing?.(),y=t,k=e}return y}let L=()=>{try{let e=GM_getValue(a.settingsKey,a.defaults);return typeof e=="string"?{...a.defaults,...JSON.parse(e)}:{...a.defaults,...e}}catch{return{...a.defaults}}},Y=e=>{try{GM_setValue(a.settingsKey,e)}catch{GM_setValue(a.settingsKey,JSON.stringify(e))}},b=e=>{let t=lt?.core?.auth?.withFreshAuth;return typeof t=="function"?t(e):e()},P="qt30-apply-pricing";async function Q(e={mount:"nav"}){for(let t=0;t<50;t++){let o=window.ensureLTHub||unsafeWindow?.ensureLTHub;if(typeof o=="function")try{let r=await o(e);if(r)return r}catch{}await new Promise(r=>setTimeout(r,100))}return null}function W(){let e=document.querySelector(".plex-wizard-page-list .plex-wizard-page.active");return e?(e.textContent||"").trim().replace(/\s+/g," "):""}function A(){return a.SHOW_ON_PAGES_RE.test(W())}async function q(){let e=await Q({mount:"nav"});!e?.registerButton||e.list?.()?.includes(P)||e.registerButton("left",{id:P,label:"Apply Pricing",title:"Apply customer catalog pricing",weight:120,onClick:()=>$()})}let T=!1,_=null;function H(e){_?.(),_=window.TMUtils?.onUrlChange?.(e)}async function g(){a.FORCE_SHOW_BTN||A()?await q():(await Q())?.remove?.(P)}let h=null;function x(){let e=document.querySelector(".plex-wizard-page-list");e&&(h=new MutationObserver(t=>{t.some(o=>o.type==="attributes"||o.type==="childList")&&g()}),h.observe(e,{subtree:!0,attributes:!0,attributeFilter:["class"],childList:!0}),window.addEventListener("hashchange",g))}function z(){try{window.removeEventListener("hashchange",g)}catch{}try{h?.disconnect()}catch{}h=null}async function D(){if(!T){T=!0;try{await Q({mount:"nav"})}catch{}await g(),x()}}function G(){T=!1,_?.(),_=null,z()}D(),H(()=>{N.some(e=>e.test(location.pathname))?D():G()});async function $(){let e=lt.core.hub.beginTask("Applying catalog pricing\u2026","info");try{try{if(!await lt.core.auth.getKey()){lt.core.hub.notify("Sign-in required","warn",{ms:4e3}),e.error("No session");return}}catch{}let t=I();if(!t){e.error("Quote_Key missing");return}await F(t);let o=await y.getHeader?.()||{},r=TMUtils.getObsValue?.(o,["Catalog_Key","CatalogKey"],{first:!0})??null;if(r||(e.update("Fetching Catalog Key\u2026"),r=(await b(()=>lt.core.plex.dsRows(a.DS_CatalogKeyByQuoteKey,{Quote_Key:t})))?.[0]?.Catalog_Key||null,r&&await y.patchHeader?.({Quote_Key:Number(t),Catalog_Key:Number(r)})),!r){e.error("No Catalog Key"),lt.core.hub.notify("No catalog found for this quote","warn",{ms:4e3});return}let u=document.querySelector(a.GRID_SEL),l=u&&w?.dataFor&&Array.isArray(w.dataFor(u)?.datasource?.raw)?w.dataFor(u).datasource.raw:[],S=[...new Set(l.map(n=>TMUtils.getObsValue?.(n,"PartNo",{first:!0,trim:!0})).filter(Boolean))];if(!S.length){e.error("No PartNo values"),lt.core.hub.notify("No PartNo values found","warn",{ms:4e3});return}e.update(`Loading ${S.length} part(s)\u2026`);let O=new Date,R={};await Promise.all(S.map(async n=>{let s=await b(()=>lt.core.plex.dsRows(a.DS_BreakpointsByPart,{Catalog_Key:r,Catalog_Part_No:n}))||[];R[n]=s.filter(i=>i.Catalog_Part_No===n&&new Date(i.Effective_Date)<=O&&O<=new Date(i.Expiration_Date)).sort((i,f)=>i.Breakpoint_Quantity-f.Breakpoint_Quantity)}));let M=L(),V=n=>+(+n).toFixed(M.unitPriceDecimals);for(let n=0;n<l.length;n++){let s=l[n],i=+(TMUtils.getObsValue(s,"Quantity",{first:!0,trim:!0})||0);if(i<=0&&M.deleteZeroQtyRows){let f=TMUtils.getObsValue(s,["QuoteKey","Quote_Key"],{first:!0,trim:!0}),d=TMUtils.getObsValue(s,["QuotePartKey","Quote_Part_Key"],{first:!0,trim:!0}),B=TMUtils.getObsValue(s,["QuotePriceKey","Quote_Price_Key"],{first:!0,trim:!0});if(f&&d&&B)try{let c=new URLSearchParams;c.set("QuoteKey",String(Number(f))),c.set("QuotePartKey",String(Number(d))),c.set("QuotePriceKey",String(Number(B)));let E=document.querySelector('input[name="__RequestVerificationToken"]')?.value||document.querySelector('meta[name="__RequestVerificationToken"]')?.content;E&&c.set("__RequestVerificationToken",E),await b(()=>lt.core.http.post("/SalesAndCRM/QuotePart/DeleteQuotePrice",c.toString(),{headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}})),lt.core.hub.notify(`Deleted row[${n}]`,"success",{ms:2500})}catch(c){U("QT30 delete error",c),lt.core.hub.notify(`Delete failed row[${n}]`,"error",{ms:3e3})}else lt.core.hub.notify(`Skip delete row[${n}] \u2014 missing keys`,"warn",{ms:2500});continue}if(i>0){let f=TMUtils.getObsValue(s,"PartNo",{first:!0,trim:!0}),d=J(R[f],i);if(d==null)continue;Z(s,V(d)),v(`QT30: row[${n}] qty=${i} price=${V(d)}`)}}e.update("Refreshing grid\u2026");let X=await j();e.success("Pricing applied"),lt.core.hub.notify(X?"Pricing applied and grid refreshed":"Pricing applied (reload may be needed)","success",{ms:3e3})}catch(t){e.error("Failed"),lt.core.hub.notify(`Apply failed: ${t?.message||t}`,"error",{ms:4e3})}finally{try{await g()}catch{}}}function I(){try{let t=document.querySelector(a.GRID_SEL),o=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko;if(t&&o?.dataFor){let r=o.dataFor(t),u=Array.isArray(r?.datasource?.raw)?r.datasource.raw[0]:null,l=u?TMUtils.getObsValue?.(u,["QuoteKey","Quote_Key"]):null;if(l!=null)return Number(l)}}catch{}try{let t=document.querySelector(".plex-wizard, .plex-page"),o=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko,r=t?o?.dataFor?.(t):null,u=r&&(TMUtils.getObsValue?.(r,["QuoteKey","Quote_Key"])||TMUtils.getObsValue?.(r,["Quote.QuoteKey","Quote.Quote_Key"]));if(u!=null)return Number(u)}catch{}let e=/[?&]QuoteKey=(\d+)/i.exec(location.search);return e?Number(e[1]):null}function J(e,t){if(!e?.length)return null;if(t<e[0].Breakpoint_Quantity)return e[0].Breakpoint_Price;let o=e[e.length-1];if(t>=o.Breakpoint_Quantity)return o.Breakpoint_Price;for(let r=0;r<e.length-1;r++)if(t>=e[r].Breakpoint_Quantity&&t<e[r+1].Breakpoint_Quantity)return e[r].Breakpoint_Price;return null}function Z(e,t){TMUtils.setObsValue(e,"RvCustomizedUnitPrice",t)}async function j(){try{let e=document.querySelector(a.GRID_SEL),t=e&&w?.dataFor?.(e);if(typeof t?.datasource?.read=="function")return await t.datasource.read(),"ds.read";if(typeof t?.refresh=="function")return t.refresh(),"vm.refresh"}catch{}try{let e=unsafeWindow.plex?.currentPage?.QuoteWizard;if(e?.navigatePage){let t=typeof e.activePage=="function"?e.activePage():e.activePage;return e.navigatePage(t),"wiz.navigatePage"}}catch{}return null}})();})();
