// ==UserScript==
// @name        QT10_DEV
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     3.6.86
// @description DEV-only build; includes user-start gate
// @match       https://*.plex.com/*
// @match       https://*.on.plex.com/*
// @require     http://localhost:5000/lt-ui-hub.js?v=3.6.86-1757700767705
// @require     http://localhost:5000/lt-core.user.js?v=3.6.86-1757700767705
// @require     http://localhost:5000/lt-data-core.user.js?v=3.6.86-1757700767705
// @require     http://localhost:5000/lt-plex-auth.user.js?v=3.6.86-1757700767705
// @require     http://localhost:5000/lt-plex-tm-utils.user.js?v=3.6.86-1757700767705
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlHttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @run-at      document-idle
// @noframes
// ==/UserScript==

(() => {
  // src/quote-tracking/qt10-customerCatalogGet/qt10.index.js
  (function() {
    "use strict";
    const DEV = true ? true : !!(typeof globalThis !== "undefined" && globalThis.__TM_DEV__);
    const CFG = {
      NAME: "QT10",
      ROUTES: [/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i],
      // KO-bound anchor we wait for to ensure VM is ready
      ANCHOR: '[data-val-property-name="CustomerNo"]',
      // Data sources
      DS_CATALOG_BY_CUSTOMER: 319,
      DS_CATALOG_CODE_BY_KEY: 22696,
      // If true, don’t pre-fire on page load; wait for a real user edit
      GATE_USER_EDIT: true,
      // Toast happy path
      TOAST_SUCCESS: true
    };
    const IS_TEST_ENV = /test\.on\.plex\.com$/i.test(location.hostname);
    try {
      TMUtils.setDebug?.(IS_TEST_ENV);
    } catch {
    }
    const L = TMUtils.getLogger?.(CFG.NAME);
    const dlog = (...a) => {
      if (IS_TEST_ENV) L?.log?.(...a);
    };
    const derror = (...a) => {
      if (IS_TEST_ENV) L?.error?.(...a);
    };
    if (!CFG.ROUTES.some((rx) => rx.test(location.pathname))) return;
    (async () => {
      const hub = await ensureLTHub({
        theme: {
          name: "OneMonroe",
          primary: "#8B0902",
          primaryHi: "#890F10",
          surface: "#ffffff"
        },
        mount: "beforePage",
        pageRootSelectors: ["#plexSidetabsMenuPage", ".plex-sidetabs-menu-page"],
        stick: false,
        gap: 8
      });
      hub.setTitle("Quote Wizard");
      hub.setStatus("Ready", "info");
    })();
    function findDC(win = typeof unsafeWindow !== "undefined" ? unsafeWindow : window) {
      try {
        if (win.lt?.core?.data) return win.lt.core.data;
      } catch {
      }
      for (let i = 0; i < win.frames.length; i++) {
        try {
          const dc = findDC(win.frames[i]);
          if (dc) return dc;
        } catch {
        }
      }
      return null;
    }
    function getTabScopeId(ns = "QT") {
      try {
        const k = `lt:${ns}:scopeId`;
        let v = sessionStorage.getItem(k);
        if (!v) {
          v = String(Math.floor(Math.random() * 2147483647));
          sessionStorage.setItem(k, v);
        }
        return Number(v);
      } catch {
        return Math.floor(Math.random() * 2147483647);
      }
    }
    const SCOPE_DRAFT = "draft";
    let QT = null;
    async function waitForDC(timeoutMs = 2e4) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        const LT = typeof unsafeWindow !== "undefined" ? unsafeWindow.lt : window.lt;
        if (LT?.core?.data?.createDataContext) {
          if (LT.core.data.makeFlatScopedRepo) return LT.core.data;
        }
        await (TMUtils.sleep?.(50) || new Promise((r) => setTimeout(r, 50)));
      }
      throw new Error("DataCore not ready");
    }
    async function getQT() {
      if (QT) return QT;
      const DC = await waitForDC();
      if (!DC.makeFlatScopedRepo) {
        await (TMUtils.sleep?.(50) || new Promise((r) => setTimeout(r, 50)));
      }
      QT = DC.makeFlatScopedRepo({ ns: "QT", entity: "quote", legacyEntity: "QuoteHeader" });
      return QT;
    }
    let repoDraft = null;
    async function ensureDraftRepo() {
      try {
        if (repoDraft) return repoDraft;
        const DC = findDC();
        if (!DC?.makeFlatScopedRepo) return null;
        const { use } = DC.makeFlatScopedRepo({ ns: "QT", entity: "quote", legacyEntity: "QuoteHeader" });
        const { repo } = use(getTabScopeId("QT"));
        repoDraft = repo;
        await repoDraft.ensureFromLegacyIfMissing?.();
        return repoDraft;
      } catch (e) {
        console.debug("QT10: repo not available yet; skipping persistence this cycle", e);
        return null;
      }
    }
    async function withFreshAuth(run) {
      try {
        return await run();
      } catch (err) {
        const status = err?.status || (/\b(\d{3})\b/.exec(err?.message || "") || [])[1];
        if (+status === 419) {
          await lt.core.auth.getKey();
          return await run();
        }
        throw err;
      }
    }
    async function ensureAuthOrToast() {
      try {
        if (await lt.core.auth.getKey()) return true;
      } catch {
      }
      window.ltUIHub?.notify("warn", "Auth looks stale. Retrying\u2026", { toast: true });
      return false;
    }
    async function anchorAppears(sel, { timeoutMs = 1e4, pollMs = 150 } = {}) {
      const t0 = Date.now();
      while (Date.now() - t0 < timeoutMs) {
        if (document.querySelector(sel)) return true;
        await (TMUtils.sleep?.(pollMs) || new Promise((r) => setTimeout(r, pollMs)));
      }
      return !!document.querySelector(sel);
    }
    let booted = false, booting = false, disposeWatcher = null, unsubscribeUrl = null;
    async function maybeBoot() {
      if (booted || booting) return;
      booting = true;
      try {
        if (!CFG.ROUTES.some((rx) => rx.test(location.pathname))) return;
        if (!await anchorAppears(CFG.ANCHOR)) return;
        if (!await ensureAuthOrToast()) return;
        const { viewModel } = await TMUtils.waitForModelAsync(CFG.ANCHOR, {
          pollMs: 200,
          timeoutMs: 8e3,
          logger: IS_TEST_ENV ? L : null
        });
        if (!viewModel) return;
        let lastCustomerNo = null;
        disposeWatcher = TMUtils.watchBySelector({
          selector: CFG.ANCHOR,
          // If user-gated, don’t fire an initial read; wait for real input
          initial: !CFG.GATE_USER_EDIT ? true : false,
          fireOn: "blur",
          settleMs: 350,
          logger: IS_TEST_ENV ? L : null,
          onChange: async () => {
            const customerNo = TMUtils.getObsValue(viewModel, "CustomerNo", { first: true, trim: true });
            if (!customerNo || customerNo === lastCustomerNo) return;
            lastCustomerNo = customerNo;
            await applyCatalogFor(customerNo, viewModel);
          }
        });
        booted = true;
      } catch (e) {
        booted = false;
        derror(`${CFG.NAME} init failed:`, e);
      } finally {
        booting = false;
      }
    }
    async function applyCatalogFor(customerNo, vm) {
      if (!customerNo) return;
      try {
        const task2 = window.ltUIHub?.beginTask("Linking catalog\u2026");
        const rows1 = await withFreshAuth(
          () => lt.core.plex.dsRows(CFG.DS_CATALOG_BY_CUSTOMER, { Customer_No: customerNo })
        );
        const row1 = Array.isArray(rows1) ? rows1[0] : null;
        const catalogKey = row1?.Catalog_Key || 0;
        if (!catalogKey) {
          task2?.error("No catalog found for this customer.");
          return;
        }
        const rows2 = await withFreshAuth(
          () => lt.core.plex.dsRows(CFG.DS_CATALOG_CODE_BY_KEY, { Catalog_Key: catalogKey })
        );
        const catalogCode = (Array.isArray(rows2) ? rows2.map((r) => r?.Catalog_Code).find(Boolean) : null) || "";
        TMUtils.setObsValue(vm, "CatalogKey", catalogKey);
        TMUtils.setObsValue(vm, "CatalogCode", catalogCode);
        const repo = await ensureDraftRepo();
        if (repo) {
          persistDraftHeaderWithRetry({
            Customer_No: String(customerNo),
            Catalog_Key: Number(catalogKey),
            Catalog_Code: String(catalogCode || ""),
            Catalog_Fetched_At: Date.now(),
            Updated_At: Date.now()
          });
        }
        const codeTrimmed = typeof catalogCode === "string" ? catalogCode.trim() : "";
        const display = codeTrimmed || String(catalogKey ?? "");
        const msg = codeTrimmed ? `Linked: ${codeTrimmed} (key ${catalogKey})` : `Linked: key ${catalogKey}`;
        task2?.success(msg, 3e3);
      } catch (err) {
        task?.error("No catalog found for this customer.");
        derror(err);
      }
    }
    const __QT10_PERSIST = { queue: null, timer: null };
    async function persistDraftHeaderWithRetry(patch, maxTries = 120, intervalMs = 250) {
      try {
        const repo = await ensureDraftRepo();
        if (repo) {
          await repo.patchHeader(patch);
          return true;
        }
      } catch (e) {
        console.debug("QT10: repo not ready now, will retry", e);
      }
      __QT10_PERSIST.queue = { ...__QT10_PERSIST.queue || {}, ...patch };
      if (__QT10_PERSIST.timer) return false;
      let triesLeft = maxTries;
      __QT10_PERSIST.timer = setInterval(async () => {
        try {
          const repoLater = await ensureDraftRepo();
          if (!repoLater) {
            if (--triesLeft <= 0) {
              clearInterval(__QT10_PERSIST.timer);
              __QT10_PERSIST.timer = null;
              console.debug("QT10: gave up persisting draft after retries");
            }
            return;
          }
          const payload = __QT10_PERSIST.queue;
          __QT10_PERSIST.queue = null;
          clearInterval(__QT10_PERSIST.timer);
          __QT10_PERSIST.timer = null;
          await repoLater.patchHeader(payload);
          console.debug("QT10: draft persisted after retry", payload);
        } catch (err) {
          console.warn("QT10: retry persist error", err);
        }
      }, intervalMs);
      return false;
    }
    unsubscribeUrl = TMUtils.onUrlChange?.(() => {
      if (!CFG.ROUTES.some((rx) => rx.test(location.pathname))) {
        try {
          disposeWatcher?.();
        } catch {
        }
        disposeWatcher = null;
        booted = false;
        booting = false;
        return;
      }
      setTimeout(maybeBoot, 0);
    });
    setTimeout(maybeBoot, 0);
    const W = typeof unsafeWindow !== "undefined" ? unsafeWindow : window;
    W.QT10_debugDraft = async () => {
      const repo = await ensureDraftRepo();
      const snap = await repo?.get();
      console.debug("QT10 draft \u2192", snap);
      return snap;
    };
    W.QT10_forceDraft = async (patch = {}) => {
      const repo = await ensureDraftRepo();
      if (!repo) {
        console.warn("QT10: repo not ready");
        return null;
      }
      await repo.patchHeader({
        Customer_No: "TEST",
        Catalog_Key: 99999,
        Catalog_Code: "TestCatalog",
        Updated_At: Date.now(),
        ...patch
      });
      return await repo.get();
    };
    W.QT10_checkDC = () => !!findDC()?.makeFlatScopedRepo;
    W.QT10_dcStatus = () => {
      const dc = findDC();
      return { hasCore: !!dc, hasFactory: !!dc?.makeFlatScopedRepo };
    };
  })();
})();
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vdG0tc2NyaXB0cy9zcmMvcXVvdGUtdHJhY2tpbmcvcXQxMC1jdXN0b21lckNhdGFsb2dHZXQvcXQxMC5pbmRleC5qcyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiLy8gc3JjL3F1b3RlLXRyYWNraW5nL3F0MTAtY3VzdG9tZXJDYXRhbG9nR2V0L3F0MTAuaW5kZXguanNcbi8vIERyb3AtaW4gbW9kdWxlIChidW5kbGVkIGJ5IGJ1aWxkLXBsdXMvZXNidWlsZCkuIE5vIFRNIGhlYWRlciBoZXJlOyB5b3VyIGJ1aWxkIGluamVjdHMgaXQuXG4vLyBSZXN0b3JlcyBidXNpbmVzcyBsb2dpYyBmcm9tIHF0MTAuYmFja3VwLmpzIGFuZCBmaXhlcyBSZXBvQmFzZSBjbGFzcyBpbnZvY2F0aW9uLlxuXG4oZnVuY3Rpb24gKCkge1xuICAgICd1c2Ugc3RyaWN0JztcblxuICAgIC8vID09PT09IERldiBmbGFnIChidWlsZC10aW1lIHdpdGggcnVudGltZSBmYWxsYmFjaykgPT09PT1cbiAgICBjb25zdCBERVYgPSAodHlwZW9mIF9fQlVJTERfREVWX18gIT09ICd1bmRlZmluZWQnKVxuICAgICAgICA/IF9fQlVJTERfREVWX19cbiAgICAgICAgOiAhISh0eXBlb2YgZ2xvYmFsVGhpcyAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsVGhpcy5fX1RNX0RFVl9fKTtcblxuICAgIC8vID09PT09IENvbmZpZyA9PT09PVxuICAgIGNvbnN0IENGRyA9IHtcbiAgICAgICAgTkFNRTogJ1FUMTAnLFxuICAgICAgICBST1VURVM6IFsvXlxcL1NhbGVzQW5kQ1JNXFwvUXVvdGVXaXphcmQoPzpcXC98JCkvaV0sXG4gICAgICAgIC8vIEtPLWJvdW5kIGFuY2hvciB3ZSB3YWl0IGZvciB0byBlbnN1cmUgVk0gaXMgcmVhZHlcbiAgICAgICAgQU5DSE9SOiAnW2RhdGEtdmFsLXByb3BlcnR5LW5hbWU9XCJDdXN0b21lck5vXCJdJyxcbiAgICAgICAgLy8gRGF0YSBzb3VyY2VzXG4gICAgICAgIERTX0NBVEFMT0dfQllfQ1VTVE9NRVI6IDMxOSxcbiAgICAgICAgRFNfQ0FUQUxPR19DT0RFX0JZX0tFWTogMjI2OTYsXG4gICAgICAgIC8vIElmIHRydWUsIGRvblx1MjAxOXQgcHJlLWZpcmUgb24gcGFnZSBsb2FkOyB3YWl0IGZvciBhIHJlYWwgdXNlciBlZGl0XG4gICAgICAgIEdBVEVfVVNFUl9FRElUOiB0cnVlLFxuICAgICAgICAvLyBUb2FzdCBoYXBweSBwYXRoXG4gICAgICAgIFRPQVNUX1NVQ0NFU1M6IHRydWUsXG4gICAgfTtcblxuICAgIC8vID09PT09IERlYnVnIC8gTG9nZ2VyIC8gREVWIHRvYXN0ID09PT09XG4gICAgY29uc3QgSVNfVEVTVF9FTlYgPSAvdGVzdFxcLm9uXFwucGxleFxcLmNvbSQvaS50ZXN0KGxvY2F0aW9uLmhvc3RuYW1lKTtcbiAgICB0cnkgeyBUTVV0aWxzLnNldERlYnVnPy4oSVNfVEVTVF9FTlYpOyB9IGNhdGNoIHsgfVxuICAgIGNvbnN0IEwgPSBUTVV0aWxzLmdldExvZ2dlcj8uKENGRy5OQU1FKTtcbiAgICBjb25zdCBkbG9nID0gKC4uLmEpID0+IHsgaWYgKElTX1RFU1RfRU5WKSBMPy5sb2c/LiguLi5hKTsgfTtcbiAgICBjb25zdCBkZXJyb3IgPSAoLi4uYSkgPT4geyBpZiAoSVNfVEVTVF9FTlYpIEw/LmVycm9yPy4oLi4uYSk7IH07XG5cbiAgICAvLyA9PT09PSBSb3V0ZSBhbGxvd2xpc3QgPT09PT1cbiAgICAvLyBhdm9pZCBkZXBlbmRpbmcgb24gVE1VdGlscyB0aW1pbmc7IHVzZSByZWdleCBvbiBwYXRobmFtZVxuICAgIGlmICghQ0ZHLlJPVVRFUy5zb21lKHJ4ID0+IHJ4LnRlc3QobG9jYXRpb24ucGF0aG5hbWUpKSkgcmV0dXJuO1xuXG4gICAgKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgaHViID0gYXdhaXQgZW5zdXJlTFRIdWIoe1xuICAgICAgICAgICAgdGhlbWU6IHtcbiAgICAgICAgICAgICAgICBuYW1lOiBcIk9uZU1vbnJvZVwiLFxuICAgICAgICAgICAgICAgIHByaW1hcnk6IFwiIzhCMDkwMlwiLFxuICAgICAgICAgICAgICAgIHByaW1hcnlIaTogXCIjODkwRjEwXCIsXG4gICAgICAgICAgICAgICAgc3VyZmFjZTogXCIjZmZmZmZmXCJcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBtb3VudDogJ2JlZm9yZVBhZ2UnLFxuICAgICAgICAgICAgcGFnZVJvb3RTZWxlY3RvcnM6IFsnI3BsZXhTaWRldGFic01lbnVQYWdlJywgJy5wbGV4LXNpZGV0YWJzLW1lbnUtcGFnZSddLFxuICAgICAgICAgICAgc3RpY2s6IGZhbHNlLFxuICAgICAgICAgICAgZ2FwOiA4XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGh1Yi5zZXRUaXRsZSgnUXVvdGUgV2l6YXJkJyk7XG4gICAgICAgIGh1Yi5zZXRTdGF0dXMoJ1JlYWR5JywgJ2luZm8nKTtcbiAgICB9KSgpO1xuXG5cblxuXG5cbiAgICAvLyA9PT0gQWRkIHRoaXMgaGVscGVyIG5lYXIgdGhlIHRvcCAob25jZSkgPT09XG4gICAgLy8gRmluZCBsdC5jb3JlLmRhdGEgaW4gYW55IHNhbWUtb3JpZ2luIGZyYW1lXG4gICAgZnVuY3Rpb24gZmluZERDKHdpbiA9ICh0eXBlb2YgdW5zYWZlV2luZG93ICE9PSAndW5kZWZpbmVkJyA/IHVuc2FmZVdpbmRvdyA6IHdpbmRvdykpIHtcbiAgICAgICAgdHJ5IHsgaWYgKHdpbi5sdD8uY29yZT8uZGF0YSkgcmV0dXJuIHdpbi5sdC5jb3JlLmRhdGE7IH0gY2F0Y2ggeyB9XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgd2luLmZyYW1lcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdHJ5IHsgY29uc3QgZGMgPSBmaW5kREMod2luLmZyYW1lc1tpXSk7IGlmIChkYykgcmV0dXJuIGRjOyB9IGNhdGNoIHsgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuXG4gICAgZnVuY3Rpb24gZ2V0VGFiU2NvcGVJZChucyA9ICdRVCcpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGsgPSBgbHQ6JHtuc306c2NvcGVJZGA7XG4gICAgICAgICAgICBsZXQgdiA9IHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oayk7XG4gICAgICAgICAgICBpZiAoIXYpIHtcbiAgICAgICAgICAgICAgICB2ID0gU3RyaW5nKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDJfMTQ3XzQ4M182NDcpKTtcbiAgICAgICAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKGssIHYpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIE51bWJlcih2KTtcbiAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICAvLyBGYWxsYmFjayBpZiBzZXNzaW9uU3RvcmFnZSBpcyBibG9ja2VkXG4gICAgICAgICAgICByZXR1cm4gTWF0aC5mbG9vcihNYXRoLnJhbmRvbSgpICogMl8xNDdfNDgzXzY0Nyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyA9PT09PSBEYXRhIHZpYSBsdC5jb3JlLmRhdGEgKGZsYXQge2hlYWRlciwgbGluZXN9KSA9PT09PVxuICAgIGNvbnN0IFNDT1BFX0RSQUZUID0gJ2RyYWZ0JztcbiAgICBsZXQgUVQgPSBudWxsO1xuICAgIGFzeW5jIGZ1bmN0aW9uIHdhaXRGb3JEQyh0aW1lb3V0TXMgPSAyMDAwMCkge1xuICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7XG4gICAgICAgIHdoaWxlIChEYXRlLm5vdygpIC0gc3RhcnQgPCB0aW1lb3V0TXMpIHtcbiAgICAgICAgICAgIGNvbnN0IExUID0gKHR5cGVvZiB1bnNhZmVXaW5kb3cgIT09ICd1bmRlZmluZWQnID8gdW5zYWZlV2luZG93Lmx0IDogd2luZG93Lmx0KTtcbiAgICAgICAgICAgIGlmIChMVD8uY29yZT8uZGF0YT8uY3JlYXRlRGF0YUNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAvLyBpZiBvdXIgZmFjdG9yeSBpcyBhbHJlYWR5IGluc3RhbGxlZCwgd2VcdTIwMTlyZSBkb25lXG4gICAgICAgICAgICAgICAgaWYgKExULmNvcmUuZGF0YS5tYWtlRmxhdFNjb3BlZFJlcG8pIHJldHVybiBMVC5jb3JlLmRhdGE7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBzbWFsbCBzbGVlcFxuICAgICAgICAgICAgYXdhaXQgKFRNVXRpbHMuc2xlZXA/Lig1MCkgfHwgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDUwKSkpO1xuICAgICAgICB9XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YUNvcmUgbm90IHJlYWR5Jyk7XG4gICAgfVxuICAgIGFzeW5jIGZ1bmN0aW9uIGdldFFUKCkge1xuICAgICAgICBpZiAoUVQpIHJldHVybiBRVDtcbiAgICAgICAgY29uc3QgREMgPSBhd2FpdCB3YWl0Rm9yREMoKTtcbiAgICAgICAgLy8gbHQtZGF0YS1jb3JlIHdpbGwgaW5zdGFsbCB0aGUgZmFjdG9yeSBzb29uIGFmdGVyIERDIGlzIHJlYWR5OyBpZiBzdGlsbCBtaXNzaW5nLCByZXRyeSBvbmNlXG4gICAgICAgIGlmICghREMubWFrZUZsYXRTY29wZWRSZXBvKSB7XG4gICAgICAgICAgICBhd2FpdCAoVE1VdGlscy5zbGVlcD8uKDUwKSB8fCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgNTApKSk7XG4gICAgICAgIH1cbiAgICAgICAgUVQgPSBEQy5tYWtlRmxhdFNjb3BlZFJlcG8oeyBuczogJ1FUJywgZW50aXR5OiAncXVvdGUnLCBsZWdhY3lFbnRpdHk6ICdRdW90ZUhlYWRlcicgfSk7XG4gICAgICAgIHJldHVybiBRVDtcbiAgICB9XG5cbiAgICBsZXQgcmVwb0RyYWZ0ID0gbnVsbDtcbiAgICBhc3luYyBmdW5jdGlvbiBlbnN1cmVEcmFmdFJlcG8oKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAocmVwb0RyYWZ0KSByZXR1cm4gcmVwb0RyYWZ0O1xuXG4gICAgICAgICAgICAvLyBOb24tYmxvY2tpbmcgcGVlayBcdTIwMTQgZG8gTk9UIHdhaXQgMjBzIGhlcmVcbiAgICAgICAgICAgIGNvbnN0IERDID0gZmluZERDKCk7XG4gICAgICAgICAgICBpZiAoIURDPy5tYWtlRmxhdFNjb3BlZFJlcG8pIHJldHVybiBudWxsO1xuICAgICAgICAgICAgY29uc3QgeyB1c2UgfSA9IERDLm1ha2VGbGF0U2NvcGVkUmVwbyh7IG5zOiAnUVQnLCBlbnRpdHk6ICdxdW90ZScsIGxlZ2FjeUVudGl0eTogJ1F1b3RlSGVhZGVyJyB9KTtcblxuICAgICAgICAgICAgY29uc3QgeyByZXBvIH0gPSB1c2UoZ2V0VGFiU2NvcGVJZCgnUVQnKSk7IC8vIDwtLSBudW1lcmljLCBwZXItdGFiIHNjb3BlXG4gICAgICAgICAgICByZXBvRHJhZnQgPSByZXBvO1xuICAgICAgICAgICAgYXdhaXQgcmVwb0RyYWZ0LmVuc3VyZUZyb21MZWdhY3lJZk1pc3Npbmc/LigpO1xuICAgICAgICAgICAgcmV0dXJuIHJlcG9EcmFmdDtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnUVQxMDogcmVwbyBub3QgYXZhaWxhYmxlIHlldDsgc2tpcHBpbmcgcGVyc2lzdGVuY2UgdGhpcyBjeWNsZScsIGUpO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIC8vID09PT09IEF1dGggaGVscGVycyA9PT09PVxuICAgIGFzeW5jIGZ1bmN0aW9uIHdpdGhGcmVzaEF1dGgocnVuKSB7XG4gICAgICAgIHRyeSB7IHJldHVybiBhd2FpdCBydW4oKTsgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0dXMgPSBlcnI/LnN0YXR1cyB8fCAoL1xcYihcXGR7M30pXFxiLy5leGVjKGVycj8ubWVzc2FnZSB8fCAnJykgfHwgW10pWzFdO1xuICAgICAgICAgICAgaWYgKCtzdGF0dXMgPT09IDQxOSkgeyBhd2FpdCBsdC5jb3JlLmF1dGguZ2V0S2V5KCk7IHJldHVybiBhd2FpdCBydW4oKTsgfVxuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9XG4gICAgfVxuICAgIGFzeW5jIGZ1bmN0aW9uIGVuc3VyZUF1dGhPclRvYXN0KCkge1xuICAgICAgICB0cnkgeyBpZiAoYXdhaXQgbHQuY29yZS5hdXRoLmdldEtleSgpKSByZXR1cm4gdHJ1ZTsgfSBjYXRjaCB7IH1cbiAgICAgICAgd2luZG93Lmx0VUlIdWI/Lm5vdGlmeSgnd2FybicsICdBdXRoIGxvb2tzIHN0YWxlLiBSZXRyeWluZ1x1MjAyNicsIHsgdG9hc3Q6IHRydWUgfSk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyA9PT09PSBET00vS08gcmVhZGluZXNzID09PT09XG4gICAgYXN5bmMgZnVuY3Rpb24gYW5jaG9yQXBwZWFycyhzZWwsIHsgdGltZW91dE1zID0gMTAwMDAsIHBvbGxNcyA9IDE1MCB9ID0ge30pIHtcbiAgICAgICAgY29uc3QgdDAgPSBEYXRlLm5vdygpO1xuICAgICAgICB3aGlsZSAoRGF0ZS5ub3coKSAtIHQwIDwgdGltZW91dE1zKSB7XG4gICAgICAgICAgICBpZiAoZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzZWwpKSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIGF3YWl0IChUTVV0aWxzLnNsZWVwPy4ocG9sbE1zKSB8fCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgcG9sbE1zKSkpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiAhIWRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Ioc2VsKTtcbiAgICB9XG5cbiAgICAvLyA9PT09PSBCb290c3RyYXAgKFNQQS1zYWZlKSA9PT09PVxuICAgIGxldCBib290ZWQgPSBmYWxzZSwgYm9vdGluZyA9IGZhbHNlLCBkaXNwb3NlV2F0Y2hlciA9IG51bGwsIHVuc3Vic2NyaWJlVXJsID0gbnVsbDtcblxuICAgIGFzeW5jIGZ1bmN0aW9uIG1heWJlQm9vdCgpIHtcbiAgICAgICAgaWYgKGJvb3RlZCB8fCBib290aW5nKSByZXR1cm47XG4gICAgICAgIGJvb3RpbmcgPSB0cnVlO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKCFDRkcuUk9VVEVTLnNvbWUocnggPT4gcngudGVzdChsb2NhdGlvbi5wYXRobmFtZSkpKSByZXR1cm47XG4gICAgICAgICAgICBpZiAoIShhd2FpdCBhbmNob3JBcHBlYXJzKENGRy5BTkNIT1IpKSkgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKCEoYXdhaXQgZW5zdXJlQXV0aE9yVG9hc3QoKSkpIHJldHVybjtcblxuICAgICAgICAgICAgY29uc3QgeyB2aWV3TW9kZWwgfSA9IGF3YWl0IFRNVXRpbHMud2FpdEZvck1vZGVsQXN5bmMoQ0ZHLkFOQ0hPUiwge1xuICAgICAgICAgICAgICAgIHBvbGxNczogMjAwLCB0aW1lb3V0TXM6IDgwMDAsIGxvZ2dlcjogSVNfVEVTVF9FTlYgPyBMIDogbnVsbFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpZiAoIXZpZXdNb2RlbCkgcmV0dXJuO1xuXG5cbiAgICAgICAgICAgIC8vIElNUE9SVEFOVDogUVQxMCBpcyBDQVRBTE9HLU9OTFk7IGRvIE5PVCBzdG9yZSBRdW90ZV9LZXkvUXVvdGVfTm8gaGVyZS5cblxuICAgICAgICAgICAgLy8gV2F0Y2ggQ3VzdG9tZXJObyBcdTIxOTIgbG9vayB1cCBjYXRhbG9nIFx1MjE5MiB3cml0ZSB0byBEUkFGVCBzY29wZVxuICAgICAgICAgICAgbGV0IGxhc3RDdXN0b21lck5vID0gbnVsbDtcbiAgICAgICAgICAgIGRpc3Bvc2VXYXRjaGVyID0gVE1VdGlscy53YXRjaEJ5U2VsZWN0b3Ioe1xuICAgICAgICAgICAgICAgIHNlbGVjdG9yOiBDRkcuQU5DSE9SLFxuICAgICAgICAgICAgICAgIC8vIElmIHVzZXItZ2F0ZWQsIGRvblx1MjAxOXQgZmlyZSBhbiBpbml0aWFsIHJlYWQ7IHdhaXQgZm9yIHJlYWwgaW5wdXRcbiAgICAgICAgICAgICAgICBpbml0aWFsOiAhQ0ZHLkdBVEVfVVNFUl9FRElUID8gdHJ1ZSA6IGZhbHNlLFxuICAgICAgICAgICAgICAgIGZpcmVPbjogJ2JsdXInLFxuICAgICAgICAgICAgICAgIHNldHRsZU1zOiAzNTAsXG4gICAgICAgICAgICAgICAgbG9nZ2VyOiBJU19URVNUX0VOViA/IEwgOiBudWxsLFxuICAgICAgICAgICAgICAgIG9uQ2hhbmdlOiBhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGN1c3RvbWVyTm8gPSBUTVV0aWxzLmdldE9ic1ZhbHVlKHZpZXdNb2RlbCwgJ0N1c3RvbWVyTm8nLCB7IGZpcnN0OiB0cnVlLCB0cmltOiB0cnVlIH0pO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWN1c3RvbWVyTm8gfHwgY3VzdG9tZXJObyA9PT0gbGFzdEN1c3RvbWVyTm8pIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgbGFzdEN1c3RvbWVyTm8gPSBjdXN0b21lck5vO1xuXG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IGFwcGx5Q2F0YWxvZ0ZvcihjdXN0b21lck5vLCB2aWV3TW9kZWwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBib290ZWQgPSB0cnVlO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBib290ZWQgPSBmYWxzZTtcbiAgICAgICAgICAgIGRlcnJvcihgJHtDRkcuTkFNRX0gaW5pdCBmYWlsZWQ6YCwgZSk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBib290aW5nID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvLyA9PT09PSBDb3JlIGJ1c2luZXNzIGxvZ2ljOiBDdXN0b21lciBcdTIxOTIgQ2F0YWxvZ0tleSBcdTIxOTIgQ2F0YWxvZ0NvZGUgPT09PT1cbiAgICBhc3luYyBmdW5jdGlvbiBhcHBseUNhdGFsb2dGb3IoY3VzdG9tZXJObywgdm0pIHtcbiAgICAgICAgaWYgKCFjdXN0b21lck5vKSByZXR1cm47XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB0YXNrID0gd2luZG93Lmx0VUlIdWI/LmJlZ2luVGFzaygnTGlua2luZyBjYXRhbG9nXHUyMDI2Jyk7XG5cbiAgICAgICAgICAgIC8vIDEpIEN1c3RvbWVyIFx1MjE5MiBDYXRhbG9nS2V5XG4gICAgICAgICAgICBjb25zdCByb3dzMSA9IGF3YWl0IHdpdGhGcmVzaEF1dGgoKCkgPT5cbiAgICAgICAgICAgICAgICBsdC5jb3JlLnBsZXguZHNSb3dzKENGRy5EU19DQVRBTE9HX0JZX0NVU1RPTUVSLCB7IEN1c3RvbWVyX05vOiBjdXN0b21lck5vIH0pXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgY29uc3Qgcm93MSA9IEFycmF5LmlzQXJyYXkocm93czEpID8gcm93czFbMF0gOiBudWxsO1xuICAgICAgICAgICAgY29uc3QgY2F0YWxvZ0tleSA9IHJvdzE/LkNhdGFsb2dfS2V5IHx8IDA7XG4gICAgICAgICAgICBpZiAoIWNhdGFsb2dLZXkpIHsgdGFzaz8uZXJyb3IoJ05vIGNhdGFsb2cgZm91bmQgZm9yIHRoaXMgY3VzdG9tZXIuJyk7IHJldHVybjsgfVxuXG4gICAgICAgICAgICAvLyAyKSBDYXRhbG9nS2V5IFx1MjE5MiBDYXRhbG9nQ29kZVxuICAgICAgICAgICAgY29uc3Qgcm93czIgPSBhd2FpdCB3aXRoRnJlc2hBdXRoKCgpID0+XG4gICAgICAgICAgICAgICAgbHQuY29yZS5wbGV4LmRzUm93cyhDRkcuRFNfQ0FUQUxPR19DT0RFX0JZX0tFWSwgeyBDYXRhbG9nX0tleTogY2F0YWxvZ0tleSB9KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnN0IGNhdGFsb2dDb2RlID0gKEFycmF5LmlzQXJyYXkocm93czIpID8gcm93czIubWFwKHIgPT4gcj8uQ2F0YWxvZ19Db2RlKS5maW5kKEJvb2xlYW4pIDogbnVsbCkgfHwgJyc7XG5cbiAgICAgICAgICAgIC8vIDMpIFJlZmxlY3QgaW4gS09cbiAgICAgICAgICAgIFRNVXRpbHMuc2V0T2JzVmFsdWUodm0sICdDYXRhbG9nS2V5JywgY2F0YWxvZ0tleSk7XG4gICAgICAgICAgICBUTVV0aWxzLnNldE9ic1ZhbHVlKHZtLCAnQ2F0YWxvZ0NvZGUnLCBjYXRhbG9nQ29kZSk7XG5cbiAgICAgICAgICAgIC8vIDQpIFN0YXNoIGludG8gRFJBRlQgc2NvcGUgKHBlci10YWIpXG4gICAgICAgICAgICAvLyBhZnRlciB5b3UndmUgY29tcHV0ZWQgY2F0YWxvZ0tleSwgY2F0YWxvZ0NvZGUsIGV0Yy5cbiAgICAgICAgICAgIGNvbnN0IHJlcG8gPSBhd2FpdCBlbnN1cmVEcmFmdFJlcG8oKTtcbiAgICAgICAgICAgIGlmIChyZXBvKSB7XG4gICAgICAgICAgICAgICAgLy8gbmV3IChub24tYmxvY2tpbmcsIGF1dG8tcmV0cmllcyB1bnRpbCBEQyBpcyByZWFkeSlcbiAgICAgICAgICAgICAgICBwZXJzaXN0RHJhZnRIZWFkZXJXaXRoUmV0cnkoe1xuICAgICAgICAgICAgICAgICAgICBDdXN0b21lcl9ObzogU3RyaW5nKGN1c3RvbWVyTm8pLFxuICAgICAgICAgICAgICAgICAgICBDYXRhbG9nX0tleTogTnVtYmVyKGNhdGFsb2dLZXkpLFxuICAgICAgICAgICAgICAgICAgICBDYXRhbG9nX0NvZGU6IFN0cmluZyhjYXRhbG9nQ29kZSB8fCAnJyksXG4gICAgICAgICAgICAgICAgICAgIENhdGFsb2dfRmV0Y2hlZF9BdDogRGF0ZS5ub3coKSxcbiAgICAgICAgICAgICAgICAgICAgVXBkYXRlZF9BdDogRGF0ZS5ub3coKSxcbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBCdWlsZCBhIGNsZWFuIGRpc3BsYXkgdmFsdWUgdGhhdCBmYWxscyBiYWNrIGNvcnJlY3RseVxuICAgICAgICAgICAgY29uc3QgY29kZVRyaW1tZWQgPSAodHlwZW9mIGNhdGFsb2dDb2RlID09PSAnc3RyaW5nJykgPyBjYXRhbG9nQ29kZS50cmltKCkgOiAnJztcbiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXkgPSBjb2RlVHJpbW1lZCB8fCBTdHJpbmcoY2F0YWxvZ0tleSA/PyAnJyk7ICAvLyBmYWxsIGJhY2sgdG8ga2V5IGlmIGNvZGUgaXMgYmxhbmtcblxuICAgICAgICAgICAgLy8gSWYgeW91XHUyMDE5ZCBsaWtlIHRvIHNob3cgYm90aCB3aGVuIGF2YWlsYWJsZTpcbiAgICAgICAgICAgIGNvbnN0IG1zZyA9IGNvZGVUcmltbWVkXG4gICAgICAgICAgICAgICAgPyBgTGlua2VkOiAke2NvZGVUcmltbWVkfSAoa2V5ICR7Y2F0YWxvZ0tleX0pYFxuICAgICAgICAgICAgICAgIDogYExpbmtlZDoga2V5ICR7Y2F0YWxvZ0tleX1gO1xuXG4gICAgICAgICAgICAvLyBGbGFzaCB0aGUgc3VjY2VzcyBmb3IgfjNzXG4gICAgICAgICAgICB0YXNrPy5zdWNjZXNzKG1zZywgMzAwMCk7XG5cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0YXNrPy5lcnJvcignTm8gY2F0YWxvZyBmb3VuZCBmb3IgdGhpcyBjdXN0b21lci4nKTtcbiAgICAgICAgICAgIGRlcnJvcihlcnIpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gLS0tLSBCZXN0LWVmZm9ydCBwZXJzaXN0ZW5jZSB3aXRoIHJldHJ5IChkcmFmdCBoZWFkZXIpIC0tLS1cbiAgICBjb25zdCBfX1FUMTBfUEVSU0lTVCA9IHsgcXVldWU6IG51bGwsIHRpbWVyOiBudWxsIH07XG4gICAgYXN5bmMgZnVuY3Rpb24gcGVyc2lzdERyYWZ0SGVhZGVyV2l0aFJldHJ5KHBhdGNoLCBtYXhUcmllcyA9IDEyMCwgaW50ZXJ2YWxNcyA9IDI1MCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgcmVwbyA9IGF3YWl0IGVuc3VyZURyYWZ0UmVwbygpOyAvLyBiZXN0LWVmZm9ydCwgbWF5IHJldHVybiBudWxsXG4gICAgICAgICAgICBpZiAocmVwbykge1xuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG8ucGF0Y2hIZWFkZXIocGF0Y2gpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmRlYnVnKCdRVDEwOiByZXBvIG5vdCByZWFkeSBub3csIHdpbGwgcmV0cnknLCBlKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGJ1ZmZlciBwYXRjaCBhbmQgc2NoZWR1bGUgcmV0cmllc1xuICAgICAgICBfX1FUMTBfUEVSU0lTVC5xdWV1ZSA9IHsgLi4uKF9fUVQxMF9QRVJTSVNULnF1ZXVlIHx8IHt9KSwgLi4ucGF0Y2ggfTtcbiAgICAgICAgaWYgKF9fUVQxMF9QRVJTSVNULnRpbWVyKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgbGV0IHRyaWVzTGVmdCA9IG1heFRyaWVzO1xuICAgICAgICBfX1FUMTBfUEVSU0lTVC50aW1lciA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgY29uc3QgcmVwb0xhdGVyID0gYXdhaXQgZW5zdXJlRHJhZnRSZXBvKCk7XG4gICAgICAgICAgICAgICAgaWYgKCFyZXBvTGF0ZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKC0tdHJpZXNMZWZ0IDw9IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoX19RVDEwX1BFUlNJU1QudGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgX19RVDEwX1BFUlNJU1QudGltZXIgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kZWJ1ZygnUVQxMDogZ2F2ZSB1cCBwZXJzaXN0aW5nIGRyYWZ0IGFmdGVyIHJldHJpZXMnKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNvbnN0IHBheWxvYWQgPSBfX1FUMTBfUEVSU0lTVC5xdWV1ZTtcbiAgICAgICAgICAgICAgICBfX1FUMTBfUEVSU0lTVC5xdWV1ZSA9IG51bGw7XG4gICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChfX1FUMTBfUEVSU0lTVC50aW1lcik7XG4gICAgICAgICAgICAgICAgX19RVDEwX1BFUlNJU1QudGltZXIgPSBudWxsO1xuICAgICAgICAgICAgICAgIGF3YWl0IHJlcG9MYXRlci5wYXRjaEhlYWRlcihwYXlsb2FkKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKCdRVDEwOiBkcmFmdCBwZXJzaXN0ZWQgYWZ0ZXIgcmV0cnknLCBwYXlsb2FkKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignUVQxMDogcmV0cnkgcGVyc2lzdCBlcnJvcicsIGVycik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIGludGVydmFsTXMpO1xuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cblxuICAgIC8vID09PT09IFNQQSBuYXYgaGFuZGxpbmcgPT09PT1cbiAgICB1bnN1YnNjcmliZVVybCA9IFRNVXRpbHMub25VcmxDaGFuZ2U/LigoKSA9PiB7XG4gICAgICAgIGlmICghQ0ZHLlJPVVRFUy5zb21lKHJ4ID0+IHJ4LnRlc3QobG9jYXRpb24ucGF0aG5hbWUpKSkge1xuICAgICAgICAgICAgdHJ5IHsgZGlzcG9zZVdhdGNoZXI/LigpOyB9IGNhdGNoIHsgfVxuICAgICAgICAgICAgZGlzcG9zZVdhdGNoZXIgPSBudWxsOyBib290ZWQgPSBmYWxzZTsgYm9vdGluZyA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHNldFRpbWVvdXQobWF5YmVCb290LCAwKTtcbiAgICB9KTtcblxuICAgIHNldFRpbWVvdXQobWF5YmVCb290LCAwKTtcblxuICAgIC8vIEV4cG9zZSBoZWxwZXJzIHRvIHRoZSBwYWdlIGNvbnRleHQgKHNvIERldlRvb2xzIGNvbnNvbGUgY2FuIGNhbGwgdGhlbSlcbiAgICBjb25zdCBXID0gKHR5cGVvZiB1bnNhZmVXaW5kb3cgIT09ICd1bmRlZmluZWQnID8gdW5zYWZlV2luZG93IDogd2luZG93KTtcblxuICAgIFcuUVQxMF9kZWJ1Z0RyYWZ0ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgICBjb25zdCByZXBvID0gYXdhaXQgZW5zdXJlRHJhZnRSZXBvKCk7XG4gICAgICAgIGNvbnN0IHNuYXAgPSBhd2FpdCByZXBvPy5nZXQoKTtcbiAgICAgICAgY29uc29sZS5kZWJ1ZygnUVQxMCBkcmFmdCBcdTIxOTInLCBzbmFwKTtcbiAgICAgICAgcmV0dXJuIHNuYXA7XG4gICAgfTtcblxuICAgIFcuUVQxMF9mb3JjZURyYWZ0ID0gYXN5bmMgKHBhdGNoID0ge30pID0+IHtcbiAgICAgICAgY29uc3QgcmVwbyA9IGF3YWl0IGVuc3VyZURyYWZ0UmVwbygpO1xuICAgICAgICBpZiAoIXJlcG8pIHsgY29uc29sZS53YXJuKCdRVDEwOiByZXBvIG5vdCByZWFkeScpOyByZXR1cm4gbnVsbDsgfVxuICAgICAgICBhd2FpdCByZXBvLnBhdGNoSGVhZGVyKHtcbiAgICAgICAgICAgIEN1c3RvbWVyX05vOiAnVEVTVCcsXG4gICAgICAgICAgICBDYXRhbG9nX0tleTogOTk5OTksXG4gICAgICAgICAgICBDYXRhbG9nX0NvZGU6ICdUZXN0Q2F0YWxvZycsXG4gICAgICAgICAgICBVcGRhdGVkX0F0OiBEYXRlLm5vdygpLFxuICAgICAgICAgICAgLi4ucGF0Y2hcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBhd2FpdCByZXBvLmdldCgpO1xuICAgIH07XG5cbiAgICBXLlFUMTBfY2hlY2tEQyA9ICgpID0+ICEhKGZpbmREQygpPy5tYWtlRmxhdFNjb3BlZFJlcG8pO1xuICAgIFcuUVQxMF9kY1N0YXR1cyA9ICgpID0+IHtcbiAgICAgICAgY29uc3QgZGMgPSBmaW5kREMoKTtcbiAgICAgICAgcmV0dXJuIHsgaGFzQ29yZTogISFkYywgaGFzRmFjdG9yeTogISFkYz8ubWFrZUZsYXRTY29wZWRSZXBvIH07XG4gICAgfTtcbn0pKCk7Il0sCiAgIm1hcHBpbmdzIjogIjs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBSUEsR0FBQyxXQUFZO0FBQ1Q7QUFHQSxVQUFNLE1BQU8sT0FDUCxPQUNBLENBQUMsRUFBRSxPQUFPLGVBQWUsZUFBZSxXQUFXO0FBR3pELFVBQU0sTUFBTTtBQUFBLE1BQ1IsTUFBTTtBQUFBLE1BQ04sUUFBUSxDQUFDLHNDQUFzQztBQUFBO0FBQUEsTUFFL0MsUUFBUTtBQUFBO0FBQUEsTUFFUix3QkFBd0I7QUFBQSxNQUN4Qix3QkFBd0I7QUFBQTtBQUFBLE1BRXhCLGdCQUFnQjtBQUFBO0FBQUEsTUFFaEIsZUFBZTtBQUFBLElBQ25CO0FBR0EsVUFBTSxjQUFjLHdCQUF3QixLQUFLLFNBQVMsUUFBUTtBQUNsRSxRQUFJO0FBQUUsY0FBUSxXQUFXLFdBQVc7QUFBQSxJQUFHLFFBQVE7QUFBQSxJQUFFO0FBQ2pELFVBQU0sSUFBSSxRQUFRLFlBQVksSUFBSSxJQUFJO0FBQ3RDLFVBQU0sT0FBTyxJQUFJLE1BQU07QUFBRSxVQUFJLFlBQWEsSUFBRyxNQUFNLEdBQUcsQ0FBQztBQUFBLElBQUc7QUFDMUQsVUFBTSxTQUFTLElBQUksTUFBTTtBQUFFLFVBQUksWUFBYSxJQUFHLFFBQVEsR0FBRyxDQUFDO0FBQUEsSUFBRztBQUk5RCxRQUFJLENBQUMsSUFBSSxPQUFPLEtBQUssUUFBTSxHQUFHLEtBQUssU0FBUyxRQUFRLENBQUMsRUFBRztBQUV4RCxLQUFDLFlBQVk7QUFDVCxZQUFNLE1BQU0sTUFBTSxZQUFZO0FBQUEsUUFDMUIsT0FBTztBQUFBLFVBQ0gsTUFBTTtBQUFBLFVBQ04sU0FBUztBQUFBLFVBQ1QsV0FBVztBQUFBLFVBQ1gs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
