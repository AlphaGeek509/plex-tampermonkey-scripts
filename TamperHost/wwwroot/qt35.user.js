// ==UserScript==
// @name        QT35
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     3.7.30
// @description Production build
// @match       https://lyntron.on.plex.com/SalesAndCRM*
// @match       https://lyntron.on.plex.com/SalesAndCrm*
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.30/TamperHost/wwwroot/lt-plex-tm-utils.user.js?v=3.7.30
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.30/TamperHost/wwwroot/lt-plex-auth.user.js?v=3.7.30
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.30/TamperHost/wwwroot/lt-ui-hub.js?v=3.7.30
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.30/TamperHost/wwwroot/lt-data-core.user.js?v=3.7.30
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.30/TamperHost/wwwroot/lt-core.user.js?v=3.7.30
// @resource     THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.7.30/TamperHost/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @run-at      document-start
// @noframes
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt35.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt35.user.js
// ==/UserScript==

(()=>{(()=>{"use strict";let i=(...t)=>!1,P=(...t)=>console.error("QT35 \u2716\uFE0F",...t),_=typeof unsafeWindow<"u"?unsafeWindow:window,S=t=>{let a=lt?.core?.auth?.withFreshAuth;return typeof a=="function"?a(t):t()},c=lt.core?.data?.makeFlatScopedRepo?lt.core.data.makeFlatScopedRepo({ns:"QT",entity:"quote",legacyEntity:"QuoteHeader"}):null;(async()=>(await window.ensureLTDock?.())?.register({id:"qt35-attachments",label:"Attachments",title:"Open QT35 Attachments",weight:120,onClick:()=>typeof openAttachmentsModal=="function"?openAttachmentsModal():lt.core.hub.notify("Attachments UI not available","warn",{toast:!0})}))();let H=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i],E=!1;if(!H.some(t=>t.test(location.pathname)))return;_.__LT_HUB_MOUNT="nav";let A=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko,I=()=>new Promise(t=>requestAnimationFrame(t));async function d(t={mount:"nav"}){for(let a=0;a<50;a++){let e=_.ensureLTHub||window.ensureLTHub;if(typeof e=="function")try{let n=await e(t);if(n)return n}catch{}await new Promise(n=>setTimeout(n,100))}return null}let u={ACTION_BAR_SEL:"#QuoteWizardSharedActionBar",GRID_SEL:".plex-grid",SHOW_ON_PAGES_RE:/^part\s*summary$/i,DS_ATTACHMENTS_BY_QUOTE:11713,ATTACHMENT_GROUP_KEY:11,DS_QUOTE_HEADER_GET:3156,POLL_MS:200,TIMEOUT_MS:12e3};function Q(t="QT"){try{let a=`lt:${t}:scopeId`,e=sessionStorage.getItem(a);return e||(e=String(Math.floor(Math.random()*2147483647)),sessionStorage.setItem(a,e)),Number(e)}catch{return Math.floor(Math.random()*2147483647)}}function M(){let t=document.querySelector(".plex-wizard-page-list .plex-wizard-page.active");return t?(t.textContent||"").trim().replace(/\s+/g," "):""}function O(){return u.SHOW_ON_PAGES_RE.test(M())}async function R(){let t=document.querySelector(u.GRID_SEL)?u.GRID_SEL:u.ACTION_BAR_SEL,{viewModel:a}=await(window.TMUtils?.waitForModelAsync(t,{pollMs:u.POLL_MS,timeoutMs:u.TIMEOUT_MS,requireKo:!0})??{viewModel:null});return a}function v(){try{let a=document.querySelector(u.GRID_SEL);if(a&&A?.dataFor){let e=A.dataFor(a),n=Array.isArray(e?.datasource?.raw)?e.datasource.raw[0]:null,r=n?window.TMUtils?.getObsValue?.(n,"QuoteKey"):null;if(r!=null)return Number(r)}}catch{}try{let a=document.querySelector(".plex-wizard, .plex-page"),e=a?A?.dataFor?.(a):null,n=e&&(window.TMUtils?.getObsValue?.(e,"QuoteKey")||window.TMUtils?.getObsValue?.(e,"Quote.QuoteKey"));if(n!=null)return Number(n)}catch{}let t=/[?&]QuoteKey=(\d+)/i.exec(location.search);return t?Number(t[1]):null}let o=null,B=null,q=null;async function m(t){if(!c)return null;let{repo:a}=c.use(Number(t));return o=a,B=Number(t),await a.ensureFromLegacyIfMissing?.(),a}let l={timer:null,tries:0,max:120,intervalMs:250};function F(t){l.timer||(l.timer=setInterval(async()=>{try{let a=await m(t);if(!c||!a){++l.tries>=l.max&&C();return}let{repo:e}=c.use(Q("QT")),n=await(e.getHeader?.()||e.get());if(n&&Object.keys(n).length){await a.patchHeader({Quote_Key:Number(t),Customer_No:n.Customer_No??null,Catalog_Key:n.Catalog_Key??null,Catalog_Code:n.Catalog_Code??null,Promoted_From:"draft",Promoted_At:Date.now(),Quote_Header_Fetched_At:null,Updated_At:n.Updated_At||Date.now()}),await e.clear?.();try{let{repo:r}=c.use("draft");await r.clear?.()}catch{}}C()}catch{}},l.intervalMs))}function C(){clearInterval(l.timer),l.timer=null,l.tries=0}async function D(t){if(!t||!Number.isFinite(t)||t<=0)return;if(!c){F(t);return}let{repo:a}=c.use(Q("QT")),e=await a.getHeader?.()||await a.get();if(!e||(await m(t),!o))return;let n=await o.getHeader()||{},r=String(n.Customer_No??""),b=String(e.Customer_No??"");if(Number((await a.get())?.Updated_At||0)>Number(n.Promoted_At||0)||r!==b||n.Catalog_Key!==e.Catalog_Key||n.Catalog_Code!==e.Catalog_Code){await o.patchHeader({Quote_Key:Number(t),Customer_No:e.Customer_No??null,Catalog_Key:e.Catalog_Key??null,Catalog_Code:e.Catalog_Code??null,Promoted_From:"draft",Promoted_At:Date.now(),Quote_Header_Fetched_At:null}),await a.clear?.();try{let{repo:$}=c.use("draft");await $.clear?.()}catch{}i("Draft merged (flat repo header updated)",{qk:t})}}async function K(t){let a=typeof getPlexFacade=="function"?await getPlexFacade():_.lt?.core?.plex;if(!a?.dsRows)return 0;let e=await S(()=>a.dsRows(u.DS_ATTACHMENTS_BY_QUOTE,{Attachment_Group_Key:u.ATTACHMENT_GROUP_KEY,Record_Key_Value:String(t)}));return Array.isArray(e)?e.length:0}function L(t){return{Customer_Code:t?.Customer_Code??null,Customer_Name:t?.Customer_Name??null,Customer_No:t?.Customer_No??null,Quote_No:t?.Quote_No??null}}async function x(t){if(await m(t),!o||(await o.getHeader()||{}).Quote_Header_Fetched_At)return;let e=typeof getPlexFacade=="function"?await getPlexFacade():_.lt?.core?.plex;if(!e?.dsRows)return;let n=await S(()=>e.dsRows(u.DS_QUOTE_HEADER_GET,{Quote_Key:String(t)})),r=Array.isArray(n)&&n.length?L(n[0]):null;r&&await o.patchHeader({Quote_Key:t,...r,Quote_Header_Fetched_At:Date.now()})}let s="qt35-attachments-btn";async function h(){let t=await d({mount:"nav"});if(!t){i("ensureHubButton: hub not available");return}if(typeof t.registerButton!="function"){i("ensureHubButton: hub.registerButton missing");return}let a=t.list?.();if(!(Array.isArray(a)&&a.includes(s))){i("ensureHubButton: registering\u2026",{id:s}),t.registerButton("left",{id:s,label:"Attachments 0",title:"Refresh attachments (manual)",weight:120,onClick:()=>w(!0)});try{window.__HUB=t,i("ensureHubButton: hub.list()",t.list?.())}catch{}i("ensureHubButton: registered")}}async function f(t){let a=Number(t??0),e=await d({mount:"nav"});if(!e?.registerButton)return;if(typeof e.updateButton=="function"){e.updateButton(s,{label:`Attachments ${a}`});return}let n=e.list?.();Array.isArray(n)&&n.includes(s)?(e.remove?.(s),e.registerButton("left",{id:s,label:`Attachments ${a}`,title:"Refresh attachments (manual)",weight:120,onClick:()=>w(!0)})):e.registerButton("left",{id:s,label:`Attachments ${a}`,title:"Refresh attachments (manual)",weight:120,onClick:()=>w(!0)})}let T=!1;async function w(t=!1){if(await h(),T)return;T=!0;let a=lt.core.hub.beginTask("Fetching Attachments\u2026","info");try{await R();let e=v();if(!e||!Number.isFinite(e)||e<=0){f(0),a.error("\u26A0\uFE0F Quote Key not found",4e3);return}if(!o||B!==e){await m(e);try{let b=await o?.getHeader?.();b?.Attachment_Count!=null&&f(Number(b.Attachment_Count))}catch{}}if(await D(e),!o){a.error("Data context not ready yet",2e3);return}let n=await K(e);f(n),await o.patchHeader({Quote_Key:e,Attachment_Count:Number(n)});let r=n>0;a.success(r?`\u2705 ${n} attachment(s)`:"\u26A0\uFE0F No attachments",2e3),t&&lt.core.hub.notify(r?`\u2705 ${n} attachment(s)`:"\u26A0\uFE0F No attachments",r?"success":"warn",{timeout:2e3,toast:!0}),i("refresh",{qk:e,count:n})}catch(e){P("refresh failed",e),a.error(`\u274C Attachments refresh failed: ${e?.message||e}`,4e3),lt.core.hub.notify(`\u274C Attachments refresh failed: ${e?.message||e}`,"error",{timeout:4e3,toast:!0})}finally{T=!1}}let N=!1,y=null;function V(t){y?.(),y=window.TMUtils?.onUrlChange?.(t)}async function U(){if(N)return;N=!0,await I();try{await d({mount:"nav"})}catch{}await h();try{await d()}catch{}if(G(),await p(),O()){await R();let a=v();if(F(a),a&&Number.isFinite(a)&&a>0){o=await m(a),await D(a),await w(!1);try{await x(a)}catch(e){console.error("QT35 hydrate failed",e)}}else f(0)}else if(E)await h(),f(0);else{f(0);try{(await d())?.remove?.(s)}catch{}}i("initialized")}function W(){N=!1,y?.(),y=null,z(),C()}U();let g=null;function G(){let t=document.querySelector(".plex-wizard-page-list");t&&(g=new MutationObserver(a=>{a.some(e=>e.type==="attributes"||e.type==="childList")&&p()}),g.observe(t,{subtree:!0,attributes:!0,attributeFilter:["class"],childList:!0}),window.addEventListener("hashchange",p))}async function p(){let t=M();if(i("reconcileHubButtonVisibility:",{pageName:t}),E||O())await h();else{let a=await d();i("reconcileHubButtonVisibility: removing button (off target page)"),a?.remove?.(s)}}function z(){try{window.removeEventListener("hashchange",p)}catch{}try{g?.disconnect()}catch{}g=null}V(()=>{H.some(t=>t.test(location.pathname))?U():W()})})();})();
