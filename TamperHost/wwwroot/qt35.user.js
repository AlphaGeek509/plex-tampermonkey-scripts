// ==UserScript==
// @name        QT35
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     4.0.1
// @description Adds Attachments badge/button (and Dock) and promotes draftâ†’quote once if needed. Counts attachments via DS 11713 (group 11) and auto-refreshes on Part Summary activation and QT20 modal close.
// @author      Jeff Nichols (OneMonroe | Lyn-Tron)
// @license     MIT
// @homepageURL https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @supportURL  https://github.com/AlphaGeek509/plex-tampermonkey-scripts/issues
// @match       https://lyntron.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.on.plex.com/SalesAndCrm/QuoteWizard*
// @match       https://lyntron.test.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.test.on.plex.com/SalesAndCrm/QuoteWizard*
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-plex-tm-utils.user.js?v=4.0.1
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-plex-auth.user.js?v=4.0.1
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-ui-hub.js?v=4.0.1
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-data-core.user.js?v=4.0.1
// @require     https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/lt-core.user.js?v=4.0.1
// @resource    THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v4.0.1/TamperHost/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @connect     cdn.jsdelivr.net
// @run-at      document-start
// @noframes
// @grant       GM_addStyle
// @grant       GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt35.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt35.user.js
// ==/UserScript==

(()=>{(()=>{"use strict";let C=(...t)=>!1,q=(...t)=>console.error("QT35 \u2716\uFE0F",...t),v=typeof unsafeWindow<"u"?unsafeWindow:window,M=t=>{let e=lt?.core?.auth?.withFreshAuth;return typeof e=="function"?e(t):t()};(async()=>(await window.ensureLTDock?.())?.register({id:"qt35-attachments",label:"Attachments",title:"Open QT35 Attachments",weight:120,onClick:()=>typeof openAttachmentsModal=="function"?openAttachmentsModal():lt.core.hub.notify("Attachments UI not available","warn",{toast:!0})}))();let p=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i],A=!1;if(!p.some(t=>t.test(location.pathname)))return;let F=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko,G=()=>new Promise(t=>requestAnimationFrame(t)),r={ACTION_BAR_SEL:"#QuoteWizardSharedActionBar",GRID_SEL:".plex-grid",SHOW_ON_PAGES_RE:/^part\s*summary$/i,DS_ATTACHMENTS_BY_QUOTE:11713,ATTACHMENT_GROUP_KEY:11,DS_QUOTE_HEADER_GET:3156,POLL_MS:200,TIMEOUT_MS:12e3};function P(){return(document.querySelector('.plex-wizard-page-list .plex-wizard-page.active, .plex-wizard-page-list .plex-wizard-page[aria-current="page"]')?.textContent||"").trim().replace(/\s+/g," ")}function d(){return r.SHOW_ON_PAGES_RE.test(P())}async function D(){let t=document.querySelector(r.GRID_SEL)?r.GRID_SEL:r.ACTION_BAR_SEL,{viewModel:e}=await(window.TMUtils?.waitForModelAsync(t,{pollMs:r.POLL_MS,timeoutMs:r.TIMEOUT_MS,requireKo:!0})??{viewModel:null});return e}let s=null,T=null,z=null;async function R(t){try{let e=await lt?.core?.qt?.useQuoteRepo?.(Number(t));return s=e,T=Number(t),e}catch{return null}}let L=t=>new Promise(e=>setTimeout(e,t));async function B(t,e=6,n=250){for(let a=0;a<e;a++){if(await R(t),s)return s;await L(n)}return null}function H(){return lt?.core?.qt?.stopRetry?.()}function Q(t){return`qt35:promoted:${Number(t)||0}`}async function U(t){let e=Q(t);try{if(sessionStorage.getItem(e)==="1")return"guarded"}catch{}let n=await lt?.core?.qt?.useDraftRepo?.(),a=n&&(await n.getHeader?.()||await n.get?.());if(!!!(a&&Object.keys(a).length))return"no-draft";let c=await lt?.core?.qt?.promoteDraftToQuote?.({qk:Number(t),strategy:"once"})||"noop";try{sessionStorage.setItem(e,"1")}catch{}return c}async function W(t){let e=typeof getPlexFacade=="function"?await getPlexFacade():v.lt?.core?.plex;if(!e?.dsRows)return 0;let n=await M(()=>e.dsRows(r.DS_ATTACHMENTS_BY_QUOTE,{Attachment_Group_Key:r.ATTACHMENT_GROUP_KEY,Record_Key_Value:String(t)}));return Array.isArray(n)?n.length:0}function K(t){return{Customer_Code:t?.Customer_Code??null,Customer_Name:t?.Customer_Name??null,Customer_No:t?.Customer_No??null,Quote_No:t?.Quote_No??null}}let i="qt35-attachments-btn";async function _(t){let e=Number(t??0),n=await lt.core.qt.getHub({mount:"nav"});if(!n?.registerButton)return;let a=`Attachments (${e})`;if(typeof n.updateButton=="function"){n.updateButton(i,{label:a});return}let o=n.list?.();Array.isArray(o)&&o.includes(i)?(n.remove?.(i),n.registerButton("left",{id:i,label:`Attachments (${e})`,title:"Refresh attachments (manual)",weight:120,onClick:()=>u(!0)})):n.registerButton("left",{id:i,label:a,title:"Refresh attachments (manual)",weight:120,onClick:()=>u(!0)})}let w=!1;async function u(t=!1){if(await lt.core.qt.ensureHubButton({id:i,label:"Attachments (0)",title:"Refresh attachments (manual)",side:"left",weight:120,onClick:()=>u(!0),showWhen:()=>!0,mount:"nav"}),w)return;w=!0;let e=lt.core.hub.beginTask("Fetching Attachments\u2026","info");try{await D();let n=lt?.core?.qt?.getQuoteContext?.(),a=Number(n?.quoteKey);if(!a||!Number.isFinite(a)||a<=0){_(0),e.error("\u26A0\uFE0F Quote Key not found",5e3);return}if(!s||T!==a){await R(a);try{let N=await s?.getHeader?.();N?.Attachment_Count!=null&&_(Number(N.Attachment_Count))}catch{}}if(await U(a),await B(a,6,250),!s){e.error("Data context warming \u2014 try again in a moment",500);return}let o=await W(a);_(o),await s.patchHeader({Quote_Key:a,Attachment_Count:Number(o)});let c=o>0;e.success(c?`${o} attachment(s)`:"No attachments",5e3),t&&lt.core.hub.notify(c?`${o} attachment(s)`:"No attachments",c?"success":"warn",{toast:!0}),C("refresh",{qk:a,count:o})}catch(n){q("refresh failed",n),e.error(`Attachments refresh failed: ${n?.message||n}`,5e3),lt.core.hub.notify(`Attachments refresh failed: ${n?.message||n}`,"error",{toast:!0})}finally{w=!1}}let S=null;function E(t){try{let e=lt?.core?.qt?.getQuoteContext?.();if(!!!(e&&(e.isOnPartSummary||r.SHOW_ON_PAGES_RE.test(e.pageName||""))))return;clearTimeout(S),S=setTimeout(()=>{u(!1)},350)}catch{}}let y=!1,f=null;function k(t){f?.(),f=window.TMUtils?.onUrlChange?.(t)}let m=!1,h=null,l=null;function O(t=250){clearTimeout(h),h=setTimeout(()=>{try{d()&&u(!1)}catch{}},t)}function g(){let t=d();t&&!m&&O(250),m=t}async function b(){if(!y){y=!0;try{window.addEventListener("LT:AttachmentRefreshRequested",E,!1)}catch{}await lt.core.qt.ensureHubButton({id:"qt35-attachments-btn",label:"Attachments (0)",title:"Refresh attachments (manual)",side:"left",weight:120,onClick:()=>u(!0),showWhen:t=>typeof A<"u"&&A||r.SHOW_ON_PAGES_RE.test(t.pageName)||t.isOnPartSummary,mount:"nav"});try{let t=document.querySelector(".plex-wizard-page-list");t&&!l&&(l=new MutationObserver(g),l.observe(t,{subtree:!0,attributes:!0,childList:!0}))}catch{}try{window.addEventListener("hashchange",g)}catch{}m=d(),m&&O(150)}}function x(){y=!1,f?.(),f=null,H();try{window.removeEventListener("LT:AttachmentRefreshRequested",E,!1)}catch{}try{window.removeEventListener("hashchange",g)}catch{}try{l?.disconnect?.()}catch{}l=null,clearTimeout(h),h=null}b(),k(()=>{p.some(t=>t.test(location.pathname))?b():x()})})();})();
