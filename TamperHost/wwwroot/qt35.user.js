// ==UserScript==
// @name        QT35
// @namespace   https://github.com/AlphaGeek509/plex-tampermonkey-scripts
// @version     3.8.100
// @description Production build
// @match       https://lyntron.on.plex.com/SalesAndCRM/QuoteWizard*
// @match       https://lyntron.on.plex.com/SalesAndCrm/QuoteWizard*
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-plex-tm-utils.user.js?v=3.8.100
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-plex-auth.user.js?v=3.8.100
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-ui-hub.js?v=3.8.100
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-data-core.user.js?v=3.8.100
// @require      https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/lt-core.user.js?v=3.8.100
// @resource     THEME_CSS https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@v3.8.100/TamperHost/wwwroot/theme.css
// @grant       GM_registerMenuCommand
// @grant       GM_getValue
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
// @grant       unsafeWindow
// @connect     *.plex.com
// @run-at      document-start
// @noframes
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @updateURL   https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt35.user.js
// @downloadURL https://cdn.jsdelivr.net/gh/AlphaGeek509/plex-tampermonkey-scripts@latest/TamperHost/wwwroot/qt35.user.js
// ==/UserScript==

(()=>{(()=>{"use strict";let R=(...t)=>!1,S=(...t)=>console.error("QT35 \u2716\uFE0F",...t),E=typeof unsafeWindow<"u"?unsafeWindow:window,N=t=>{let e=lt?.core?.auth?.withFreshAuth;return typeof e=="function"?e(t):t()};(async()=>(await window.ensureLTDock?.())?.register({id:"qt35-attachments",label:"Attachments",title:"Open QT35 Attachments",weight:120,onClick:()=>typeof openAttachmentsModal=="function"?openAttachmentsModal():lt.core.hub.notify("Attachments UI not available","warn",{toast:!0})}))();let _=[/^\/SalesAndCRM\/QuoteWizard(?:\/|$)/i],l=!1;if(!_.some(t=>t.test(location.pathname)))return;let L=typeof unsafeWindow<"u"?unsafeWindow.ko:window.ko,U=()=>new Promise(t=>requestAnimationFrame(t)),a={ACTION_BAR_SEL:"#QuoteWizardSharedActionBar",GRID_SEL:".plex-grid",SHOW_ON_PAGES_RE:/^part\s*summary$/i,DS_ATTACHMENTS_BY_QUOTE:11713,ATTACHMENT_GROUP_KEY:11,DS_QUOTE_HEADER_GET:3156,POLL_MS:200,TIMEOUT_MS:12e3};async function O(){let t=document.querySelector(a.GRID_SEL)?a.GRID_SEL:a.ACTION_BAR_SEL,{viewModel:e}=await(window.TMUtils?.waitForModelAsync(t,{pollMs:a.POLL_MS,timeoutMs:a.TIMEOUT_MS,requireKo:!0})??{viewModel:null});return e}let s=null,w=null,k=null;async function y(t){try{let e=await lt?.core?.qt?.useQuoteRepo?.(Number(t));return s=e,w=Number(t),e}catch{return null}}let b=t=>new Promise(e=>setTimeout(e,t));async function C(t,e=6,n=250){for(let o=0;o<e;o++){if(await y(t),s)return s;await b(n)}return null}function q(){return lt?.core?.qt?.stopRetry?.()}function D(t){return`qt35:promoted:${Number(t)||0}`}async function M(t){let e=D(t);try{if(sessionStorage.getItem(e)==="1")return"guarded"}catch{}let n=await lt?.core?.qt?.useDraftRepo?.(),o=n&&(await n.getHeader?.()||await n.get?.());if(!!!(o&&Object.keys(o).length))return"no-draft";let i=await lt?.core?.qt?.promoteDraftToQuote?.({qk:Number(t),strategy:"once"})||"noop";try{sessionStorage.setItem(e,"1")}catch{}return i}async function P(t){let e=typeof getPlexFacade=="function"?await getPlexFacade():E.lt?.core?.plex;if(!e?.dsRows)return 0;let n=await N(()=>e.dsRows(a.DS_ATTACHMENTS_BY_QUOTE,{Attachment_Group_Key:a.ATTACHMENT_GROUP_KEY,Record_Key_Value:String(t)}));return Array.isArray(n)?n.length:0}function I(t){return{Customer_Code:t?.Customer_Code??null,Customer_Name:t?.Customer_Name??null,Customer_No:t?.Customer_No??null,Quote_No:t?.Quote_No??null}}let u="qt35-attachments-btn";async function m(t){let e=Number(t??0),n=await lt.core.qt.getHub({mount:"nav"});if(!n?.registerButton)return;if(typeof n.updateButton=="function"){n.updateButton(u,{label:`Attachments ${e}`});return}let o=n.list?.();Array.isArray(o)&&o.includes(u)?(n.remove?.(u),n.registerButton("left",{id:u,label:`Attachments ${e}`,title:"Refresh attachments (manual)",weight:120,onClick:()=>c(!0)})):n.registerButton("left",{id:u,label:`Attachments ${e}`,title:"Refresh attachments (manual)",weight:120,onClick:()=>c(!0)})}let h=!1;async function c(t=!1){if(await lt.core.qt.ensureHubButton({id:u,label:"Attachments 0",title:"Refresh attachments (manual)",side:"left",weight:120,onClick:()=>c(!0),showWhen:n=>typeof l<"u"&&l||a.SHOW_ON_PAGES_RE.test(n.pageName)||n.isOnPartSummary,mount:"nav"}),h)return;h=!0;let e=lt.core.hub.beginTask("Fetching Attachments\u2026","info");try{await O();let n=lt?.core?.qt?.getQuoteContext?.(),o=Number(n?.quoteKey);if(!o||!Number.isFinite(o)||o<=0){m(0),e.error("\u26A0\uFE0F Quote Key not found",4e3);return}if(!s||w!==o){await y(o);try{let T=await s?.getHeader?.();T?.Attachment_Count!=null&&m(Number(T.Attachment_Count))}catch{}}if(await M(o),await C(o,6,250),!s){e.error("Data context warming \u2014 try again in a moment",2500);return}let r=await P(o);m(r),await s.patchHeader({Quote_Key:o,Attachment_Count:Number(r)});let i=r>0;e.success(i?`\u2705 ${r} attachment(s)`:"\u26A0\uFE0F No attachments",2e3),t&&lt.core.hub.notify(i?`\u2705 ${r} attachment(s)`:"\u26A0\uFE0F No attachments",i?"success":"warn",{timeout:2e3,toast:!0}),R("refresh",{qk:o,count:r})}catch(n){S("refresh failed",n),e.error(`\u274C Attachments refresh failed: ${n?.message||n}`,4e3),lt.core.hub.notify(`\u274C Attachments refresh failed: ${n?.message||n}`,"error",{timeout:4e3,toast:!0})}finally{h=!1}}let A=null;function p(t){try{let e=lt?.core?.qt?.getQuoteContext?.();if(!!!(e&&(e.isOnPartSummary||a.SHOW_ON_PAGES_RE.test(e.pageName||""))))return;clearTimeout(A),A=setTimeout(()=>{c(!1)},350)}catch{}}let d=!1,f=null;function B(t){f?.(),f=window.TMUtils?.onUrlChange?.(t)}async function g(){if(!d){d=!0;try{window.addEventListener("LT:AttachmentRefreshRequested",p,!1)}catch{}await lt.core.qt.ensureHubButton({id:"qt35-attachments-btn",label:"Attachments 0",title:"Refresh attachments (manual)",side:"left",weight:120,onClick:()=>c(!0),showWhen:t=>typeof l<"u"&&l||a.SHOW_ON_PAGES_RE.test(t.pageName)||t.isOnPartSummary,mount:"nav"})}}function H(){d=!1,f?.(),f=null,q();try{window.removeEventListener("LT:AttachmentRefreshRequested",p,!1)}catch{}}g(),B(()=>{_.some(t=>t.test(location.pathname))?g():H()})})();})();
